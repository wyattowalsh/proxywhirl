{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "MetricsConfig",
  "description": "Configuration schema for ProxyWhirl metrics collection and exposition",
  "type": "object",
  "required": [
    "enabled",
    "exposition_host",
    "exposition_port",
    "exposition_path",
    "scrape_interval_seconds",
    "enable_process_metrics",
    "enable_pool_metrics",
    "enable_request_metrics",
    "histogram_buckets",
    "label_cardinality_limit"
  ],
  "properties": {
    "enabled": {
      "type": "boolean",
      "description": "Enable/disable metrics collection globally",
      "default": true
    },
    "exposition_host": {
      "type": "string",
      "description": "Host for /metrics endpoint",
      "default": "0.0.0.0",
      "pattern": "^([a-zA-Z0-9.-]+|\\*)$"
    },
    "exposition_port": {
      "type": "integer",
      "description": "Port for /metrics endpoint",
      "default": 9090,
      "minimum": 1024,
      "maximum": 65535
    },
    "exposition_path": {
      "type": "string",
      "description": "HTTP path for metrics endpoint",
      "default": "/metrics",
      "pattern": "^/.*"
    },
    "scrape_interval_seconds": {
      "type": "integer",
      "description": "Expected Prometheus scrape interval (seconds)",
      "default": 60,
      "minimum": 1,
      "maximum": 3600
    },
    "enable_process_metrics": {
      "type": "boolean",
      "description": "Include Python process metrics (CPU, memory)",
      "default": true
    },
    "enable_pool_metrics": {
      "type": "boolean",
      "description": "Include proxy pool size/health metrics",
      "default": true
    },
    "enable_request_metrics": {
      "type": "boolean",
      "description": "Include request count/latency metrics",
      "default": true
    },
    "histogram_buckets": {
      "type": "array",
      "description": "Latency histogram bucket boundaries (seconds)",
      "items": {
        "type": "number",
        "minimum": 0
      },
      "minItems": 2,
      "default": [0.1, 0.5, 1.0, 2.0, 5.0, 10.0]
    },
    "label_cardinality_limit": {
      "type": "integer",
      "description": "Max unique label combinations to prevent cardinality explosion",
      "default": 1000,
      "minimum": 100,
      "maximum": 10000
    },
    "basic_auth_username": {
      "type": ["string", "null"],
      "description": "Username for /metrics basic auth (optional)",
      "minLength": 3
    },
    "basic_auth_password": {
      "type": ["string", "null"],
      "description": "Password for /metrics basic auth (optional, SecretStr in Python)",
      "minLength": 8
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "basic_auth_username": {
            "type": "string"
          }
        },
        "required": ["basic_auth_username"]
      },
      "then": {
        "required": ["basic_auth_password"]
      }
    },
    {
      "if": {
        "properties": {
          "basic_auth_password": {
            "type": "string"
          }
        },
        "required": ["basic_auth_password"]
      },
      "then": {
        "required": ["basic_auth_username"]
      }
    }
  ],
  "examples": [
    {
      "enabled": true,
      "exposition_host": "127.0.0.1",
      "exposition_port": 9090,
      "exposition_path": "/metrics",
      "scrape_interval_seconds": 60,
      "enable_process_metrics": true,
      "enable_pool_metrics": true,
      "enable_request_metrics": true,
      "histogram_buckets": [0.1, 0.5, 1.0, 2.0, 5.0, 10.0],
      "label_cardinality_limit": 1000,
      "basic_auth_username": "prometheus",
      "basic_auth_password": "secure_password"
    }
  ]
}
