<!DOCTYPE html>
<html lang="en" data-accent-color="violet" data-content_root="../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Advanced Rotation Strategies - ProxyWhirl Documentation</title><link rel="shortcut icon" href="../_static/favicon.svg"/><link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Caching Subsystem Guide" href="caching.html" /><link rel="prev" title="Async Client Guide" href="async-client.html" />
      <link rel="canonical" href="https://www.proxywhirl.com/docs/guides/advanced-strategies.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=e1a1ceaf" />
    <link rel="stylesheet" type="text/css" href="../_static/shibuya.css?v=44020203" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link media="print" rel="stylesheet" type="text/css" href="../_static/print.css?v=20ff2c19" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=b31b09b0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/>
  <meta property="og:url" content="https://www.proxywhirl.com/docs/guides/advanced-strategies.html"/>
  <meta property="og:title" content="Advanced Rotation Strategies"/>
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@wyaborern"/>
<meta name="twitter:site" content="@wyaborern"/>
  </head>
<body>
<a class="skip-link" href="#main-content">Skip to content</a>
<header class="pw-navbar">
  <div class="pw-navbar-inner">
    
    <button class="pw-navbar-sidebar-toggle js-menu" aria-controls="lside" aria-expanded="false" aria-label="Toggle navigation" type="button">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
    </button>

    
    <a href="../index.html" class="pw-navbar-brand">
      <svg class="pw-navbar-logo" viewBox="0 0 100 100" aria-hidden="true">
        <defs>
          <linearGradient id="pw-logo-grad" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#06b6d4"/>
            <stop offset="50%" stop-color="#3b82f6"/>
            <stop offset="100%" stop-color="#8b5cf6"/>
          </linearGradient>
        </defs>
        <circle cx="50" cy="50" r="44" fill="none" stroke="url(#pw-logo-grad)" stroke-width="6" stroke-linecap="round" stroke-dasharray="60 30"/>
        <g fill="url(#pw-logo-grad)">
          <path d="M50 18 L58 30 L52 30 L52 42 L48 42 L48 30 L42 30 Z"/>
          <path d="M82 50 L70 58 L70 52 L58 52 L58 48 L70 48 L70 42 Z"/>
          <path d="M50 82 L42 70 L48 70 L48 58 L52 58 L52 70 L58 70 Z"/>
          <path d="M18 50 L30 42 L30 48 L42 48 L42 52 L30 52 L30 58 Z"/>
        </g>
        <circle cx="50" cy="50" r="8" fill="url(#pw-logo-grad)"/>
      </svg>
      <strong>ProxyWhirl</strong>
    </a>

    
    <nav class="pw-navbar-links" aria-label="Main navigation">
      <a href="../getting-started/index.html" class="pw-navbar-link" data-section="getting-started">
        Getting Started
      </a>
      <a href="index.html" class="pw-navbar-link" data-section="guides">
        Guides
      </a>
      <a href="../reference/index.html" class="pw-navbar-link" data-section="reference">
        Reference
      </a>
      <a href="../project/index.html" class="pw-navbar-link" data-section="project">
        Project
      </a>
    </nav>

    
    <div class="pw-navbar-actions">
      
      <button class="pw-navbar-btn" id="pw-theme-toggle" type="button" aria-label="Toggle theme" aria-pressed="false">
        <svg class="pw-icon-sun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
        <svg class="pw-icon-moon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
      </button>

      
      <a href="https://github.com/wyattowalsh/proxywhirl" class="pw-navbar-btn pw-navbar-github" target="_blank" rel="noopener noreferrer" aria-label="GitHub">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>
      </a>
    </div>
  </div>
</header>
<div id="main-content"></div>

<script>
(function() {
  /* Theme toggle */
  var toggle = document.getElementById('pw-theme-toggle');
  if (toggle) {
    /* Set initial aria-pressed based on current theme */
    var currentlyDark = document.documentElement.classList.contains('dark');
    toggle.setAttribute('aria-pressed', currentlyDark ? 'true' : 'false');

    toggle.addEventListener('click', function() {
      var isDark = document.documentElement.classList.contains('dark');
      var next = isDark ? 'light' : 'dark';
      localStorage._theme = next;
      if (typeof setColorMode === 'function') {
        setColorMode(next);
      } else {
        var html = document.documentElement;
        html.classList.remove('dark', 'light');
        html.classList.add(next);
        html.setAttribute('data-color-mode', next);
      }
      toggle.setAttribute('aria-pressed', next === 'dark' ? 'true' : 'false');
    });
  }

  /* Active nav link detection — highlight current section */
  var path = window.location.pathname;
  var links = document.querySelectorAll('.pw-navbar-link[data-section]');
  links.forEach(function(link) {
    var section = link.getAttribute('data-section');
    if (path.indexOf('/' + section) !== -1) {
      link.classList.add('active');
    }
  });
  /* Mark home page — none active, or all inactive is fine */
})();
</script>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="2"><ul class="current">
<li class="toctree-l1 _expand"><a class="reference internal" href="../getting-started/index.html">Getting Started</a><ul>
<li class="toctree-l2 _expand"><a class="reference internal" href="../getting-started/index.html#what-youll-build">What You&#8217;ll Build</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../getting-started/index.html#installation">Installation</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../getting-started/index.html#quick-start">Quick Start</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/index.html#basic-usage-sync">Basic Usage (sync)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/index.html#async-usage">Async Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/index.html#context-manager-pattern">Context Manager Pattern</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/index.html#authenticated-proxies">Authenticated Proxies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/index.html#using-free-proxy-lists">Using Free Proxy Lists</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/index.html#fetching-proxies-programmatically">Fetching Proxies Programmatically</a></li>
</ul>
</li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../getting-started/index.html#choosing-a-rotation-strategy">Choosing a Rotation Strategy</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../getting-started/index.html#configuring-retry-and-circuit-breakers">Configuring Retry and Circuit Breakers</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../getting-started/index.html#monitoring-your-pool">Monitoring Your Pool</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../getting-started/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../getting-started/index.html#next-steps">Next Steps</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../getting-started/index.html#for-contributors">For Contributors</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/rotation-strategies.html">Rotation Strategies</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/rotation-strategies.html#bootstrap-a-rotator">Bootstrap a Rotator</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/rotation-strategies.html#decision-matrix">Decision Matrix</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/rotation-strategies.html#quick-pick-guide">Quick-Pick Guide</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/rotation-strategies.html#strategy-reference">Strategy Reference</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/rotation-strategies.html#comparison-at-a-glance">Comparison At a Glance</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/rotation-strategies.html#hot-swapping-strategies">Hot-Swapping Strategies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/rotation-strategies.html#observe-the-pool">Observe the Pool</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/rotation-strategies.html#building-a-custom-strategy">Building a Custom Strategy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/rotation-strategies.html#further-reading">Further Reading</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Guides</a><ul class="current">
<li class="toctree-l2 _expand"><a class="reference internal" href="index.html#choosing-a-guide">Choosing a Guide</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="index.html#client-concurrency">Client &amp; Concurrency</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="index.html#resilience-caching">Resilience &amp; Caching</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="index.html#operations-deployment">Operations &amp; Deployment</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#automation-ai">Automation &amp; AI</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="async-client.html">Async Client Guide</a><ul>
<li class="toctree-l4"><a class="reference internal" href="async-client.html#when-to-use-async-vs-sync">When to Use Async vs Sync</a></li>
<li class="toctree-l4"><a class="reference internal" href="async-client.html#initialization">Initialization</a></li>
<li class="toctree-l4"><a class="reference internal" href="async-client.html#context-manager-usage">Context Manager Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="async-client.html#http-request-methods">HTTP Request Methods</a></li>
<li class="toctree-l4"><a class="reference internal" href="async-client.html#proxy-management">Proxy Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="async-client.html#hot-swapping-strategies">Hot-Swapping Strategies</a></li>
<li class="toctree-l4"><a class="reference internal" href="async-client.html#error-handling">Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="async-client.html#concurrent-requests-with-asyncio-gather">Concurrent Requests with asyncio.gather</a></li>
<li class="toctree-l4"><a class="reference internal" href="async-client.html#performance-considerations">Performance Considerations</a></li>
<li class="toctree-l4"><a class="reference internal" href="async-client.html#asyncio-integration-patterns">Asyncio Integration Patterns</a></li>
<li class="toctree-l4"><a class="reference internal" href="async-client.html#comparison-async-vs-sync">Comparison: Async vs Sync</a></li>
<li class="toctree-l4"><a class="reference internal" href="async-client.html#best-practices-and-common-patterns">Best Practices and Common Patterns</a></li>
<li class="toctree-l4"><a class="reference internal" href="async-client.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Advanced Rotation Strategies</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#performance-based-strategy">Performance-Based Strategy</a></li>
<li class="toctree-l4"><a class="reference internal" href="#session-persistence-strategy">Session Persistence Strategy</a></li>
<li class="toctree-l4"><a class="reference internal" href="#geo-targeted-strategy">Geo-Targeted Strategy</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cost-aware-strategy">Cost-Aware Strategy</a></li>
<li class="toctree-l4"><a class="reference internal" href="#composite-strategy">Composite Strategy</a></li>
<li class="toctree-l4"><a class="reference internal" href="#strategy-registry">Strategy Registry</a></li>
<li class="toctree-l4"><a class="reference internal" href="#selectioncontext">SelectionContext</a></li>
<li class="toctree-l4"><a class="reference internal" href="#strategyconfig">StrategyConfig</a></li>
<li class="toctree-l4"><a class="reference internal" href="#custom-strategy-implementation">Custom Strategy Implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#strategyregistry-usage">StrategyRegistry Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id16">Best Practices</a></li>
<li class="toctree-l4"><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing-strategies">Testing Strategies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#performance-benchmarks">Performance Benchmarks</a></li>
<li class="toctree-l4"><a class="reference internal" href="#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="caching.html">Caching Subsystem Guide</a><ul>
<li class="toctree-l4"><a class="reference internal" href="caching.html#architecture-overview">Architecture Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="caching.html#core-components">Core Components</a></li>
<li class="toctree-l4"><a class="reference internal" href="caching.html#credential-encryption">Credential Encryption</a></li>
<li class="toctree-l4"><a class="reference internal" href="caching.html#ttl-and-expiration">TTL and Expiration</a></li>
<li class="toctree-l4"><a class="reference internal" href="caching.html#health-invalidation">Health Invalidation</a></li>
<li class="toctree-l4"><a class="reference internal" href="caching.html#migration-from-jsonl-l2-cache">Migration from JSONL L2 Cache</a></li>
<li class="toctree-l4"><a class="reference internal" href="caching.html#cache-warming">Cache Warming</a></li>
<li class="toctree-l4"><a class="reference internal" href="caching.html#performance-tuning">Performance Tuning</a></li>
<li class="toctree-l4"><a class="reference internal" href="caching.html#cli-integration">CLI Integration</a></li>
<li class="toctree-l4"><a class="reference internal" href="caching.html#best-practices">Best Practices</a></li>
<li class="toctree-l4"><a class="reference internal" href="caching.html#example-complete-cache-setup">Example: Complete Cache Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="caching.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l4"><a class="reference internal" href="caching.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="retry-failover.html">Retry &amp; Failover Guide</a><ul>
<li class="toctree-l4"><a class="reference internal" href="retry-failover.html#architecture-overview">Architecture Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="retry-failover.html#when-to-use-retry-vs-failover">When to Use Retry vs Failover</a></li>
<li class="toctree-l4"><a class="reference internal" href="retry-failover.html#retrypolicy-configuration">RetryPolicy Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="retry-failover.html#circuit-breaker-configuration">Circuit Breaker Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="retry-failover.html#intelligent-proxy-selection">Intelligent Proxy Selection</a></li>
<li class="toctree-l4"><a class="reference internal" href="retry-failover.html#retrymetrics-and-observability">RetryMetrics and Observability</a></li>
<li class="toctree-l4"><a class="reference internal" href="retry-failover.html#retryexecutor-deep-dive">RetryExecutor Deep Dive</a></li>
<li class="toctree-l4"><a class="reference internal" href="retry-failover.html#integration-with-proxyrotator">Integration with ProxyRotator</a></li>
<li class="toctree-l4"><a class="reference internal" href="retry-failover.html#advanced-patterns">Advanced Patterns</a></li>
<li class="toctree-l4"><a class="reference internal" href="retry-failover.html#best-practices">Best Practices</a></li>
<li class="toctree-l4"><a class="reference internal" href="retry-failover.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l4"><a class="reference internal" href="retry-failover.html#performance-impact">Performance Impact</a></li>
<li class="toctree-l4"><a class="reference internal" href="retry-failover.html#see-also">See Also</a></li>
<li class="toctree-l4"><a class="reference internal" href="retry-failover.html#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="deployment-security.html">Deployment Security &amp; Reverse Proxy Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="deployment-security.html#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="deployment-security.html#x-forwarded-for-security">X-Forwarded-For Security</a></li>
<li class="toctree-l4"><a class="reference internal" href="deployment-security.html#reverse-proxy-configurations">Reverse Proxy Configurations</a></li>
<li class="toctree-l4"><a class="reference internal" href="deployment-security.html#proxywhirl-configuration">ProxyWhirl Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="deployment-security.html#security-checklist">Security Checklist</a></li>
<li class="toctree-l4"><a class="reference internal" href="deployment-security.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l4"><a class="reference internal" href="deployment-security.html#references">References</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="cli-reference.html">CLI Reference</a><ul>
<li class="toctree-l4"><a class="reference internal" href="cli-reference.html#installation">Installation</a></li>
<li class="toctree-l4"><a class="reference internal" href="cli-reference.html#global-options">Global Options</a></li>
<li class="toctree-l4"><a class="reference internal" href="cli-reference.html#commands">Commands</a></li>
<li class="toctree-l4"><a class="reference internal" href="cli-reference.html#output-formats">Output Formats</a></li>
<li class="toctree-l4"><a class="reference internal" href="cli-reference.html#configuration-file">Configuration File</a></li>
<li class="toctree-l4"><a class="reference internal" href="cli-reference.html#advanced-usage">Advanced Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="cli-reference.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l4"><a class="reference internal" href="cli-reference.html#environment-variables">Environment Variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="cli-reference.html#exit-codes">Exit Codes</a></li>
<li class="toctree-l4"><a class="reference internal" href="cli-reference.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="automation.html">Automation &amp; CI/CD Runbook</a><ul>
<li class="toctree-l4"><a class="reference internal" href="automation.html#pre-flight-checks">Pre-flight Checks</a></li>
<li class="toctree-l4"><a class="reference internal" href="automation.html#github-actions-ci-pipeline">GitHub Actions CI Pipeline</a></li>
<li class="toctree-l4"><a class="reference internal" href="automation.html#cron-based-proxy-fetching">Cron-Based Proxy Fetching</a></li>
<li class="toctree-l4"><a class="reference internal" href="automation.html#docker-deployment">Docker Deployment</a></li>
<li class="toctree-l4"><a class="reference internal" href="automation.html#integration-testing-patterns">Integration Testing Patterns</a></li>
<li class="toctree-l4"><a class="reference internal" href="automation.html#smoke-tests-for-docs-examples">Smoke Tests for Docs Examples</a></li>
<li class="toctree-l4"><a class="reference internal" href="automation.html#automating-releases">Automating Releases</a></li>
<li class="toctree-l4"><a class="reference internal" href="automation.html#docsearch-credentials">DocSearch Credentials</a></li>
<li class="toctree-l4"><a class="reference internal" href="automation.html#ci-stage-summary">CI Stage Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="automation.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="mcp-server.html">MCP Server Guide</a><ul>
<li class="toctree-l4"><a class="reference internal" href="mcp-server.html#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="mcp-server.html#quick-start">Quick Start</a></li>
<li class="toctree-l4"><a class="reference internal" href="mcp-server.html#the-proxywhirl-tool">The <code class="docutils literal notranslate"><span class="pre">proxywhirl</span></code> Tool</a></li>
<li class="toctree-l4"><a class="reference internal" href="mcp-server.html#resources">Resources</a></li>
<li class="toctree-l4"><a class="reference internal" href="mcp-server.html#prompts">Prompts</a></li>
<li class="toctree-l4"><a class="reference internal" href="mcp-server.html#authentication">Authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="mcp-server.html#progress-reporting">Progress Reporting</a></li>
<li class="toctree-l4"><a class="reference internal" href="mcp-server.html#transport-options">Transport Options</a></li>
<li class="toctree-l4"><a class="reference internal" href="mcp-server.html#integration-with-claude-desktop">Integration with Claude Desktop</a></li>
<li class="toctree-l4"><a class="reference internal" href="mcp-server.html#programmatic-usage">Programmatic Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="mcp-server.html#lifecycle-management">Lifecycle Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="mcp-server.html#error-handling">Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="mcp-server.html#best-practices">Best Practices</a></li>
<li class="toctree-l4"><a class="reference internal" href="mcp-server.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l4"><a class="reference internal" href="mcp-server.html#see-also">See Also</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 _expand"><a class="reference internal" href="../reference/index.html">Reference</a><ul>
<li class="toctree-l2 _expand"><a class="reference internal" href="../reference/index.html#quick-lookup">Quick Lookup</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../reference/index.html#api-surfaces">API Surfaces</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../reference/index.html#configuration-error-handling">Configuration &amp; Error Handling</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../reference/index.html#subsystem-apis">Subsystem APIs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/rest-api.html">ProxyWhirl REST API Usage Guide</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/rest-api.html#table-of-contents">Table of Contents</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rest-api.html#getting-started">Getting Started</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rest-api.html#authentication">Authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rest-api.html#middleware">Middleware</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rest-api.html#endpoint-reference">Endpoint Reference</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rest-api.html#rate-limiting">Rate Limiting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rest-api.html#error-handling">Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rest-api.html#performance-tips">Performance Tips</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rest-api.html#security-best-practices">Security Best Practices</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rest-api.html#deployment-examples">Deployment Examples</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rest-api.html#x-forwarded-for-security-checklist">X-Forwarded-For Security Checklist</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rest-api.html#security-references">Security References</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rest-api.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rest-api.html#see-also">See Also</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rest-api.html#support">Support</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reference/python-api.html">Python API Reference</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/python-api.html#core-classes">Core Classes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/python-api.html#rotation-strategies">Rotation Strategies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/python-api.html#data-models">Data Models</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/python-api.html#cache-components">Cache Components</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/python-api.html#retry-failover">Retry &amp; Failover</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/python-api.html#parsers">Parsers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/python-api.html#utility-functions">Utility Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/python-api.html#enumerations">Enumerations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/python-api.html#built-in-proxy-sources">Built-in Proxy Sources</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/python-api.html#exceptions">Exceptions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/python-api.html#type-annotations">Type Annotations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/python-api.html#version">Version</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/python-api.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reference/configuration.html">Configuration Reference</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/configuration.html#configuration-discovery">Configuration Discovery</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/configuration.html#toml-configuration-format">TOML Configuration Format</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/configuration.html#environment-variables">Environment Variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/configuration.html#configuration-classes">Configuration Classes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/configuration.html#programmatic-configuration">Programmatic Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/configuration.html#validation-rules">Validation Rules</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/configuration.html#security-best-practices">Security Best Practices</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/configuration.html#configuration-examples">Configuration Examples</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/configuration.html#migration-from-legacy-config">Migration from Legacy Config</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/configuration.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/configuration.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reference/exceptions.html">Exceptions Reference</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/exceptions.html#table-of-contents">Table of Contents</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/exceptions.html#exception-hierarchy">Exception Hierarchy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/exceptions.html#proxyerrorcode-enum">ProxyErrorCode Enum</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/exceptions.html#utility-functions">Utility Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/exceptions.html#error-codes">Error Codes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/exceptions.html#exception-reference">Exception Reference</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/exceptions.html#error-handling-patterns">Error Handling Patterns</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/exceptions.html#best-practices">Best Practices</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/exceptions.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/exceptions.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reference/cache-api.html">Cache API Reference</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/cache-api.html#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/cache-api.html#data-models">Data Models</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/cache-api.html#tier-implementations">Tier Implementations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/cache-api.html#utilities">Utilities</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/cache-api.html#usage-examples">Usage Examples</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/cache-api.html#performance-considerations">Performance Considerations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/cache-api.html#thread-safety">Thread Safety</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/cache-api.html#error-handling">Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/cache-api.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reference/rate-limiting-api.html">Rate Limiting API Reference</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/rate-limiting-api.html#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rate-limiting-api.html#core-classes">Core Classes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rate-limiting-api.html#data-models">Data Models</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rate-limiting-api.html#usage-examples">Usage Examples</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rate-limiting-api.html#thread-safety">Thread Safety</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rate-limiting-api.html#performance-considerations">Performance Considerations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rate-limiting-api.html#integration-with-monitoring">Integration with Monitoring</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rate-limiting-api.html#sphinx-integration">Sphinx Integration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rate-limiting-api.html#common-patterns">Common Patterns</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rate-limiting-api.html#faq">FAQ</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/rate-limiting-api.html#see-also">See Also</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 _expand"><a class="reference internal" href="../project/index.html">Project</a><ul>
<li class="toctree-l2 _expand"><a class="reference internal" href="../project/index.html#development-setup">Development Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../project/index.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="../project/index.html#clone-install">Clone &amp; Install</a></li>
<li class="toctree-l3"><a class="reference internal" href="../project/index.html#verify-installation">Verify Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../project/index.html#make-commands">Make Commands</a></li>
</ul>
</li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../project/index.html#contributing">Contributing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../project/index.html#workflow">Workflow</a></li>
<li class="toctree-l3"><a class="reference internal" href="../project/index.html#branch-naming">Branch Naming</a></li>
<li class="toctree-l3"><a class="reference internal" href="../project/index.html#commit-convention">Commit Convention</a></li>
<li class="toctree-l3"><a class="reference internal" href="../project/index.html#code-style">Code Style</a></li>
<li class="toctree-l3"><a class="reference internal" href="../project/index.html#pre-commit-hooks">Pre-commit Hooks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../project/index.html#testing-guidelines">Testing Guidelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../project/index.html#extending-with-custom-strategies">Extending with Custom Strategies</a></li>
</ul>
</li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../project/index.html#ci-cd-pipelines">CI/CD Pipelines</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../project/index.html#quality-gate-pipeline">Quality Gate Pipeline</a></li>
</ul>
</li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../project/index.html#architecture">Architecture</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../project/index.html#module-map">Module Map</a></li>
<li class="toctree-l3"><a class="reference internal" href="../project/index.html#key-exports">Key Exports</a></li>
</ul>
</li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../project/index.html#environment-variables">Environment Variables</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../project/index.html#current-health">Current Health</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../project/index.html#changelog-highlights">Changelog Highlights</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../project/index.html#recent">Recent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../project/index.html#phase-completion-status">Phase Completion Status</a></li>
</ul>
</li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../project/index.html#license">License</a></li>
</ul>
</li>
</ul>
        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div class="localtoc"><h3>On this page</h3><ul>
<li><a class="reference internal" href="#overview">Overview</a><ul>
<li><a class="reference internal" href="#available-strategies">Available Strategies</a></li>
</ul>
</li>
<li><a class="reference internal" href="#performance-based-strategy">Performance-Based Strategy</a><ul>
<li><a class="reference internal" href="#when-to-use">When to Use</a></li>
<li><a class="reference internal" href="#performance-characteristics">Performance Characteristics</a></li>
<li><a class="reference internal" href="#configuration">Configuration</a></li>
<li><a class="reference internal" href="#how-it-works">How It Works</a></li>
<li><a class="reference internal" href="#warmup-period">Warmup Period</a></li>
<li><a class="reference internal" href="#adaptation-example">Adaptation Example</a></li>
<li><a class="reference internal" href="#success-criteria">Success Criteria</a></li>
</ul>
</li>
<li><a class="reference internal" href="#session-persistence-strategy">Session Persistence Strategy</a><ul>
<li><a class="reference internal" href="#id1">When to Use</a></li>
<li><a class="reference internal" href="#id2">Performance Characteristics</a></li>
<li><a class="reference internal" href="#id3">Configuration</a></li>
<li><a class="reference internal" href="#session-lifecycle">Session Lifecycle</a></li>
<li><a class="reference internal" href="#session-management">Session Management</a></li>
<li><a class="reference internal" href="#failover-behavior">Failover Behavior</a></li>
<li><a class="reference internal" href="#ttl-and-expiration">TTL and Expiration</a></li>
<li><a class="reference internal" href="#lru-eviction">LRU Eviction</a></li>
<li><a class="reference internal" href="#id4">Success Criteria</a></li>
</ul>
</li>
<li><a class="reference internal" href="#geo-targeted-strategy">Geo-Targeted Strategy</a><ul>
<li><a class="reference internal" href="#id5">When to Use</a></li>
<li><a class="reference internal" href="#id6">Performance Characteristics</a></li>
<li><a class="reference internal" href="#id7">Configuration</a></li>
<li><a class="reference internal" href="#country-codes">Country Codes</a></li>
<li><a class="reference internal" href="#filtering-logic">Filtering Logic</a></li>
<li><a class="reference internal" href="#fallback-modes">Fallback Modes</a></li>
<li><a class="reference internal" href="#secondary-selection-strategies">Secondary Selection Strategies</a></li>
<li><a class="reference internal" href="#retry-integration">Retry Integration</a></li>
<li><a class="reference internal" href="#id8">Success Criteria</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cost-aware-strategy">Cost-Aware Strategy</a><ul>
<li><a class="reference internal" href="#id9">When to Use</a></li>
<li><a class="reference internal" href="#id10">Configuration</a></li>
<li><a class="reference internal" href="#weight-calculation">Weight Calculation</a></li>
<li><a class="reference internal" href="#cost-threshold-filtering">Cost Threshold Filtering</a></li>
<li><a class="reference internal" href="#best-practices">Best Practices</a></li>
</ul>
</li>
<li><a class="reference internal" href="#composite-strategy">Composite Strategy</a><ul>
<li><a class="reference internal" href="#id11">When to Use</a></li>
<li><a class="reference internal" href="#id12">Performance Characteristics</a></li>
<li><a class="reference internal" href="#architecture">Architecture</a></li>
<li><a class="reference internal" href="#basic-composition">Basic Composition</a></li>
<li><a class="reference internal" href="#common-patterns">Common Patterns</a></li>
<li><a class="reference internal" href="#configuration-from-dict">Configuration from Dict</a></li>
<li><a class="reference internal" href="#validation-example">Validation Example</a></li>
<li><a class="reference internal" href="#performance-considerations">Performance Considerations</a></li>
<li><a class="reference internal" href="#id13">Success Criteria</a></li>
</ul>
</li>
<li><a class="reference internal" href="#strategy-registry">Strategy Registry</a><ul>
<li><a class="reference internal" href="#registration">Registration</a></li>
<li><a class="reference internal" href="#validation">Validation</a></li>
<li><a class="reference internal" href="#thread-safety">Thread Safety</a></li>
<li><a class="reference internal" href="#listing-strategies">Listing Strategies</a></li>
</ul>
</li>
<li><a class="reference internal" href="#selectioncontext">SelectionContext</a><ul>
<li><a class="reference internal" href="#fields">Fields</a></li>
<li><a class="reference internal" href="#usage-with-strategies">Usage with Strategies</a></li>
</ul>
</li>
<li><a class="reference internal" href="#strategyconfig">StrategyConfig</a><ul>
<li><a class="reference internal" href="#id14">Fields</a></li>
<li><a class="reference internal" href="#per-strategy-configuration">Per-Strategy Configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#custom-strategy-implementation">Custom Strategy Implementation</a><ul>
<li><a class="reference internal" href="#implementing-the-protocol">Implementing the Protocol</a></li>
<li><a class="reference internal" href="#registering-custom-strategies">Registering Custom Strategies</a></li>
</ul>
</li>
<li><a class="reference internal" href="#strategyregistry-usage">StrategyRegistry Usage</a><ul>
<li><a class="reference internal" href="#registration-and-validation">Registration and Validation</a></li>
<li><a class="reference internal" href="#strategy-validation">Strategy Validation</a></li>
<li><a class="reference internal" href="#id15">Thread Safety</a></li>
<li><a class="reference internal" href="#unregistering-strategies">Unregistering Strategies</a></li>
<li><a class="reference internal" href="#testing-with-registry-reset">Testing with Registry Reset</a></li>
<li><a class="reference internal" href="#performance-requirements">Performance Requirements</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id16">Best Practices</a><ul>
<li><a class="reference internal" href="#choose-the-right-strategy">1. Choose the Right Strategy</a></li>
<li><a class="reference internal" href="#warm-up-performance-based-strategies">2. Warm Up Performance-Based Strategies</a></li>
<li><a class="reference internal" href="#monitor-session-memory">3. Monitor Session Memory</a></li>
<li><a class="reference internal" href="#use-selectioncontext-consistently">4. Use SelectionContext Consistently</a></li>
<li><a class="reference internal" href="#validate-geo-data-availability">5. Validate Geo Data Availability</a></li>
</ul>
</li>
<li><a class="reference internal" href="#troubleshooting">Troubleshooting</a><ul>
<li><a class="reference internal" href="#proxypoolemptyerror-no-proxies-with-ema-data">ProxyPoolEmptyError: No proxies with EMA data</a></li>
<li><a class="reference internal" href="#sessionpersistencestrategy-requires-selectioncontext-with-session-id">SessionPersistenceStrategy requires SelectionContext with session_id</a></li>
<li><a class="reference internal" href="#geo-targeting-returns-unexpected-proxies">Geo-targeting returns unexpected proxies</a></li>
<li><a class="reference internal" href="#composite-strategy-too-slow">Composite strategy too slow</a></li>
</ul>
</li>
<li><a class="reference internal" href="#testing-strategies">Testing Strategies</a></li>
<li><a class="reference internal" href="#performance-benchmarks">Performance Benchmarks</a><ul>
<li><a class="reference internal" href="#selection-time">Selection Time</a></li>
<li><a class="reference internal" href="#memory-usage">Memory Usage</a></li>
<li><a class="reference internal" href="#id17">Success Criteria</a></li>
</ul>
</li>
<li><a class="reference internal" href="#see-also">See Also</a></li>
</ul>
</div><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">ProxyWhirl</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="index.html"><span itemprop="name">Guides</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">Advanced Rotation Strategies</strong>
        <meta itemprop="position" content="3" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="relative min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
  <div class="copy-page-wrapper relative pb-4 lg:absolute lg:top-8 lg:right-6 xl:right-12">
  <div id="copy-page-trigger">
    <button
      type="button"
      class="js-copy px-3 py-1 inline-flex items-center gap-1"
      data-url="https://www.proxywhirl.com/docs/_sources/guides/advanced-strategies.md.txt"
    >
      <i class="i-lucide" data-icon="copy"></i>
      <span>Copy page</span>
    </button>
    <button class="js-menu px-2 py-1" type="button" aria-label="More actions"
      aria-haspopup="menu" aria-expanded="false" aria-controls="copy-page-content">
      <i class="i-lucide chevron-down"></i>
    </button>
  </div>
  <div id="copy-page-content" role="menu" aria-orientation="vertical" aria-hidden="true">
    <div role="presentation">
      <div class="flex flex-col" role="group">
        <button class="js-copy" type="button" role="menuitem"
          data-url="https://www.proxywhirl.com/docs/_sources/guides/advanced-strategies.md.txt">
          <span class="iconify-icon">
            <i class="i-lucide" data-icon="copy"></i>
          </span>
          <span>Copy page</span>
        </button>
        <a role="menuitem" href="https://www.proxywhirl.com/docs/_sources/guides/advanced-strategies.md.txt" target="_blank" rel="nofollow"><iconify-icon icon="bi:markdown"></iconify-icon>
            <span>View as Markdown</span></a><a role="menuitem" href="https://chatgpt.com/?hints=search&q=Read%20https%3A//www.proxywhirl.com/docs/_sources/guides/advanced-strategies.md.txt%20so%20I%20can%20ask%20questions%20about%20it." target="_blank" rel="nofollow">
          <iconify-icon icon="bi:openai"></iconify-icon>
          <span>Open in ChatGPT</span>
        </a><a role="menuitem" href="https://claude.ai/new?q=Read%20https%3A//www.proxywhirl.com/docs/_sources/guides/advanced-strategies.md.txt%20so%20I%20can%20ask%20questions%20about%20it." target="_blank" rel="nofollow">
          <iconify-icon icon="bi:claude"></iconify-icon>
          <span>Open in Claude</span>
        </a></div>
    </div>
  </div>
</div><article class="yue dark-code" role="main">
          <section id="advanced-rotation-strategies">
<h1>Advanced Rotation Strategies<a class="headerlink" href="#advanced-rotation-strategies" title="Link to this heading">¶</a></h1>
<p>ProxyWhirl provides 9 built-in rotation strategies for intelligent proxy selection. This guide covers the advanced strategies beyond basic round-robin and random selection, including performance-based routing, session persistence, geo-targeting, cost optimization, and composite strategies.</p>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id18">Overview</a></p>
<ul>
<li><p><a class="reference internal" href="#available-strategies" id="id19">Available Strategies</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#performance-based-strategy" id="id20">Performance-Based Strategy</a></p>
<ul>
<li><p><a class="reference internal" href="#when-to-use" id="id21">When to Use</a></p></li>
<li><p><a class="reference internal" href="#performance-characteristics" id="id22">Performance Characteristics</a></p></li>
<li><p><a class="reference internal" href="#configuration" id="id23">Configuration</a></p></li>
<li><p><a class="reference internal" href="#how-it-works" id="id24">How It Works</a></p></li>
<li><p><a class="reference internal" href="#warmup-period" id="id25">Warmup Period</a></p></li>
<li><p><a class="reference internal" href="#adaptation-example" id="id26">Adaptation Example</a></p></li>
<li><p><a class="reference internal" href="#success-criteria" id="id27">Success Criteria</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#session-persistence-strategy" id="id28">Session Persistence Strategy</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id29">When to Use</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id30">Performance Characteristics</a></p></li>
<li><p><a class="reference internal" href="#id3" id="id31">Configuration</a></p></li>
<li><p><a class="reference internal" href="#session-lifecycle" id="id32">Session Lifecycle</a></p></li>
<li><p><a class="reference internal" href="#session-management" id="id33">Session Management</a></p></li>
<li><p><a class="reference internal" href="#failover-behavior" id="id34">Failover Behavior</a></p></li>
<li><p><a class="reference internal" href="#ttl-and-expiration" id="id35">TTL and Expiration</a></p></li>
<li><p><a class="reference internal" href="#lru-eviction" id="id36">LRU Eviction</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id37">Success Criteria</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#geo-targeted-strategy" id="id38">Geo-Targeted Strategy</a></p>
<ul>
<li><p><a class="reference internal" href="#id5" id="id39">When to Use</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id40">Performance Characteristics</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id41">Configuration</a></p></li>
<li><p><a class="reference internal" href="#country-codes" id="id42">Country Codes</a></p></li>
<li><p><a class="reference internal" href="#filtering-logic" id="id43">Filtering Logic</a></p></li>
<li><p><a class="reference internal" href="#fallback-modes" id="id44">Fallback Modes</a></p></li>
<li><p><a class="reference internal" href="#secondary-selection-strategies" id="id45">Secondary Selection Strategies</a></p></li>
<li><p><a class="reference internal" href="#retry-integration" id="id46">Retry Integration</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id47">Success Criteria</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#cost-aware-strategy" id="id48">Cost-Aware Strategy</a></p>
<ul>
<li><p><a class="reference internal" href="#id9" id="id49">When to Use</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id50">Configuration</a></p></li>
<li><p><a class="reference internal" href="#weight-calculation" id="id51">Weight Calculation</a></p></li>
<li><p><a class="reference internal" href="#cost-threshold-filtering" id="id52">Cost Threshold Filtering</a></p></li>
<li><p><a class="reference internal" href="#best-practices" id="id53">Best Practices</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#composite-strategy" id="id54">Composite Strategy</a></p>
<ul>
<li><p><a class="reference internal" href="#id11" id="id55">When to Use</a></p></li>
<li><p><a class="reference internal" href="#id12" id="id56">Performance Characteristics</a></p></li>
<li><p><a class="reference internal" href="#architecture" id="id57">Architecture</a></p></li>
<li><p><a class="reference internal" href="#basic-composition" id="id58">Basic Composition</a></p></li>
<li><p><a class="reference internal" href="#common-patterns" id="id59">Common Patterns</a></p></li>
<li><p><a class="reference internal" href="#configuration-from-dict" id="id60">Configuration from Dict</a></p></li>
<li><p><a class="reference internal" href="#validation-example" id="id61">Validation Example</a></p></li>
<li><p><a class="reference internal" href="#performance-considerations" id="id62">Performance Considerations</a></p></li>
<li><p><a class="reference internal" href="#id13" id="id63">Success Criteria</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#strategy-registry" id="id64">Strategy Registry</a></p>
<ul>
<li><p><a class="reference internal" href="#registration" id="id65">Registration</a></p></li>
<li><p><a class="reference internal" href="#validation" id="id66">Validation</a></p></li>
<li><p><a class="reference internal" href="#thread-safety" id="id67">Thread Safety</a></p></li>
<li><p><a class="reference internal" href="#listing-strategies" id="id68">Listing Strategies</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#selectioncontext" id="id69">SelectionContext</a></p>
<ul>
<li><p><a class="reference internal" href="#fields" id="id70">Fields</a></p></li>
<li><p><a class="reference internal" href="#usage-with-strategies" id="id71">Usage with Strategies</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#strategyconfig" id="id72">StrategyConfig</a></p>
<ul>
<li><p><a class="reference internal" href="#id14" id="id73">Fields</a></p></li>
<li><p><a class="reference internal" href="#per-strategy-configuration" id="id74">Per-Strategy Configuration</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#custom-strategy-implementation" id="id75">Custom Strategy Implementation</a></p>
<ul>
<li><p><a class="reference internal" href="#implementing-the-protocol" id="id76">Implementing the Protocol</a></p></li>
<li><p><a class="reference internal" href="#registering-custom-strategies" id="id77">Registering Custom Strategies</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#strategyregistry-usage" id="id78">StrategyRegistry Usage</a></p>
<ul>
<li><p><a class="reference internal" href="#registration-and-validation" id="id79">Registration and Validation</a></p></li>
<li><p><a class="reference internal" href="#strategy-validation" id="id80">Strategy Validation</a></p></li>
<li><p><a class="reference internal" href="#id15" id="id81">Thread Safety</a></p></li>
<li><p><a class="reference internal" href="#unregistering-strategies" id="id82">Unregistering Strategies</a></p></li>
<li><p><a class="reference internal" href="#testing-with-registry-reset" id="id83">Testing with Registry Reset</a></p></li>
<li><p><a class="reference internal" href="#performance-requirements" id="id84">Performance Requirements</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id16" id="id85">Best Practices</a></p>
<ul>
<li><p><a class="reference internal" href="#choose-the-right-strategy" id="id86">1. Choose the Right Strategy</a></p></li>
<li><p><a class="reference internal" href="#warm-up-performance-based-strategies" id="id87">2. Warm Up Performance-Based Strategies</a></p></li>
<li><p><a class="reference internal" href="#monitor-session-memory" id="id88">3. Monitor Session Memory</a></p></li>
<li><p><a class="reference internal" href="#use-selectioncontext-consistently" id="id89">4. Use SelectionContext Consistently</a></p></li>
<li><p><a class="reference internal" href="#validate-geo-data-availability" id="id90">5. Validate Geo Data Availability</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#troubleshooting" id="id91">Troubleshooting</a></p>
<ul>
<li><p><a class="reference internal" href="#proxypoolemptyerror-no-proxies-with-ema-data" id="id92">ProxyPoolEmptyError: No proxies with EMA data</a></p></li>
<li><p><a class="reference internal" href="#sessionpersistencestrategy-requires-selectioncontext-with-session-id" id="id93">SessionPersistenceStrategy requires SelectionContext with session_id</a></p></li>
<li><p><a class="reference internal" href="#geo-targeting-returns-unexpected-proxies" id="id94">Geo-targeting returns unexpected proxies</a></p></li>
<li><p><a class="reference internal" href="#composite-strategy-too-slow" id="id95">Composite strategy too slow</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#testing-strategies" id="id96">Testing Strategies</a></p></li>
<li><p><a class="reference internal" href="#performance-benchmarks" id="id97">Performance Benchmarks</a></p>
<ul>
<li><p><a class="reference internal" href="#selection-time" id="id98">Selection Time</a></p></li>
<li><p><a class="reference internal" href="#memory-usage" id="id99">Memory Usage</a></p></li>
<li><p><a class="reference internal" href="#id17" id="id100">Success Criteria</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#see-also" id="id101">See Also</a></p></li>
</ul>
</nav>
<section id="overview">
<h2><a class="toc-backref" href="#id18" role="doc-backlink">Overview</a><a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>All strategies implement the <code class="docutils literal notranslate"><span class="pre">RotationStrategy</span></code> protocol:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">Optional</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Proxy</span><span class="p">,</span> <span class="n">ProxyPool</span><span class="p">,</span> <span class="n">SelectionContext</span>
</span><span data-line="3">
</span><span data-line="4"><span class="k">class</span><span class="w"> </span><span class="nc">RotationStrategy</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
</span><span data-line="5"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Protocol defining interface for proxy rotation strategies.&quot;&quot;&quot;</span>
</span><span data-line="6">
</span><span data-line="7">    <span class="k">def</span><span class="w"> </span><span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">:</span> <span class="n">ProxyPool</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SelectionContext</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Proxy</span><span class="p">:</span>
</span><span data-line="8"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Select a proxy from the pool based on strategy logic.&quot;&quot;&quot;</span>
</span><span data-line="9">        <span class="o">...</span>
</span><span data-line="10">
</span><span data-line="11">    <span class="k">def</span><span class="w"> </span><span class="nf">record_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">:</span> <span class="n">Proxy</span><span class="p">,</span> <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">response_time_ms</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="12"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record the result of using a proxy.&quot;&quot;&quot;</span>
</span><span data-line="13">        <span class="o">...</span>
</span></pre></div>
</div>
<section id="available-strategies">
<h3><a class="toc-backref" href="#id19" role="doc-backlink">Available Strategies</a><a class="headerlink" href="#available-strategies" title="Link to this heading">¶</a></h3>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Strategy</p></th>
<th class="head"><p>Use Case</p></th>
<th class="head"><p>Key Feature</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">RoundRobinStrategy</span></code></p></td>
<td><p>Even distribution</p></td>
<td><p>Sequential rotation</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">RandomStrategy</span></code></p></td>
<td><p>Unpredictable patterns</p></td>
<td><p>Random selection</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">WeightedStrategy</span></code></p></td>
<td><p>Custom prioritization</p></td>
<td><p>Configurable weights</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">LeastUsedStrategy</span></code></p></td>
<td><p>Load balancing</p></td>
<td><p>Tracks request count</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">PerformanceBasedStrategy</span></code></p></td>
<td><p>Speed optimization</p></td>
<td><p>EMA response times</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">SessionPersistenceStrategy</span></code></p></td>
<td><p>Sticky sessions</p></td>
<td><p>Session-to-proxy binding</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">GeoTargetedStrategy</span></code></p></td>
<td><p>Geographic routing</p></td>
<td><p>Country/region filtering</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">CostAwareStrategy</span></code></p></td>
<td><p>Cost optimization</p></td>
<td><p>Free proxy prioritization</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">CompositeStrategy</span></code></p></td>
<td><p>Complex requirements</p></td>
<td><p>Combines multiple strategies</p></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
<section id="performance-based-strategy">
<h2><a class="toc-backref" href="#id20" role="doc-backlink">Performance-Based Strategy</a><a class="headerlink" href="#performance-based-strategy" title="Link to this heading">¶</a></h2>
<p>Selects proxies using weighted random selection based on inverse EMA (Exponential Moving Average) response times. Faster proxies receive higher selection weights, adaptively favoring better-performing proxies while still giving all proxies a chance.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Uses the cold-start exploration pattern: new proxies get equal selection probability for the first N requests (default: 5) before being subject to performance-based weighting.</p>
</div>
<section id="when-to-use">
<h3><a class="toc-backref" href="#id21" role="doc-backlink">When to Use</a><a class="headerlink" href="#when-to-use" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Speed is critical</strong> (latency-sensitive applications)</p></li>
<li><p><strong>Proxy performance varies significantly</strong> across your pool</p></li>
<li><p><strong>Need automatic adaptation</strong> to changing conditions</p></li>
<li><p><strong>Heterogeneous proxy pools</strong> with mixed performance characteristics</p></li>
</ul>
</section>
<section id="performance-characteristics">
<h3><a class="toc-backref" href="#id22" role="doc-backlink">Performance Characteristics</a><a class="headerlink" href="#performance-characteristics" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Selection overhead:</strong> &lt;1ms (weighted random with exploration)</p></li>
<li><p><strong>Performance gain:</strong> 15-25% faster average response times vs round-robin</p></li>
<li><p><strong>Adaptation speed:</strong> Configurable via <code class="docutils literal notranslate"><span class="pre">ema_alpha</span></code> (0.0-1.0)</p></li>
<li><p><strong>Cold start:</strong> Exploration trials (default: 5) prevent proxy starvation</p></li>
</ul>
</section>
<section id="configuration">
<h3><a class="toc-backref" href="#id23" role="doc-backlink">Configuration</a><a class="headerlink" href="#configuration" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProxyRotator</span><span class="p">,</span> <span class="n">Proxy</span><span class="p">,</span> <span class="n">StrategyConfig</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.strategies</span><span class="w"> </span><span class="kn">import</span> <span class="n">PerformanceBasedStrategy</span>
</span><span data-line="3">
</span><span data-line="4"><span class="c1"># Create proxies</span>
</span><span data-line="5"><span class="n">proxies</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="6">    <span class="n">Proxy</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://proxy1.example.com:8080&quot;</span><span class="p">),</span>
</span><span data-line="7">    <span class="n">Proxy</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://proxy2.example.com:8080&quot;</span><span class="p">),</span>
</span><span data-line="8">    <span class="n">Proxy</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://proxy3.example.com:8080&quot;</span><span class="p">),</span>
</span><span data-line="9"><span class="p">]</span>
</span><span data-line="10">
</span><span data-line="11"><span class="c1"># Configure strategy with EMA parameters via StrategyConfig (not on Proxy)</span>
</span><span data-line="12"><span class="n">config</span> <span class="o">=</span> <span class="n">StrategyConfig</span><span class="p">(</span>
</span><span data-line="13">    <span class="n">ema_alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>  <span class="c1"># Smoothing factor: higher = more weight to recent values</span>
</span><span data-line="14"><span class="p">)</span>
</span><span data-line="15">
</span><span data-line="16"><span class="n">strategy</span> <span class="o">=</span> <span class="n">PerformanceBasedStrategy</span><span class="p">()</span>
</span><span data-line="17"><span class="n">strategy</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span data-line="18">
</span><span data-line="19"><span class="c1"># Use with rotator</span>
</span><span data-line="20"><span class="n">rotator</span> <span class="o">=</span> <span class="n">ProxyRotator</span><span class="p">(</span><span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">)</span>
</span><span data-line="21"><span class="n">response</span> <span class="o">=</span> <span class="n">rotator</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://api.example.com/data&quot;</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="how-it-works">
<h3><a class="toc-backref" href="#id24" role="doc-backlink">How It Works</a><a class="headerlink" href="#how-it-works" title="Link to this heading">¶</a></h3>
<p>The strategy uses <strong>inverse EMA response time</strong> as selection weight:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="n">weight</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">proxy</span><span class="o">.</span><span class="n">ema_response_time_ms</span>
</span></pre></div>
</div>
<p>Faster proxies (lower EMA) get exponentially higher selection probability.</p>
<p><strong>EMA Update Formula:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="n">EMA_new</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">current_value</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">EMA_old</span>
</span></pre></div>
</div>
<p><strong>Alpha Tuning:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">alpha=0.1</span></code>: Slow adaptation, stable (10% weight to new samples)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">alpha=0.2</span></code>: Balanced (default)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">alpha=0.5</span></code>: Fast adaptation, reactive</p></li>
</ul>
</section>
<section id="warmup-period">
<h3><a class="toc-backref" href="#id25" role="doc-backlink">Warmup Period</a><a class="headerlink" href="#warmup-period" title="Link to this heading">¶</a></h3>
<p>New proxies need historical data before they can be selected:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProxyPool</span>
</span><span data-line="2">
</span><span data-line="3"><span class="n">pool</span> <span class="o">=</span> <span class="n">ProxyPool</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;perf-pool&quot;</span><span class="p">)</span>
</span><span data-line="4">
</span><span data-line="5"><span class="c1"># Warm up new proxies with initial requests</span>
</span><span data-line="6"><span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span><span class="p">:</span>
</span><span data-line="7">    <span class="n">proxy</span><span class="o">.</span><span class="n">start_request</span><span class="p">()</span>
</span><span data-line="8">    <span class="n">proxy</span><span class="o">.</span><span class="n">complete_request</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">response_time_ms</span><span class="o">=</span><span class="mf">100.0</span><span class="p">)</span>
</span><span data-line="9">    <span class="n">pool</span><span class="o">.</span><span class="n">add_proxy</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
</span><span data-line="10">
</span><span data-line="11"><span class="n">strategy</span> <span class="o">=</span> <span class="n">PerformanceBasedStrategy</span><span class="p">()</span>
</span><span data-line="12">
</span><span data-line="13"><span class="c1"># Now strategy can select from proxies with EMA data</span>
</span><span data-line="14"><span class="n">selected</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>
</span></pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">LeastUsedStrategy</span></code> or <code class="docutils literal notranslate"><span class="pre">RoundRobinStrategy</span></code> during initial warmup to distribute requests evenly, then switch to <code class="docutils literal notranslate"><span class="pre">PerformanceBasedStrategy</span></code> once all proxies have EMA data. See <a class="reference internal" href="async-client.html"><span class="doc">Async Client Guide</span></a> for hot-swapping strategies at runtime.</p>
</div>
</section>
<section id="adaptation-example">
<h3><a class="toc-backref" href="#id26" role="doc-backlink">Adaptation Example</a><a class="headerlink" href="#adaptation-example" title="Link to this heading">¶</a></h3>
<p>The strategy automatically adapts to changing proxy performance:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">SelectionContext</span>
</span><span data-line="2">
</span><span data-line="3"><span class="c1"># Simulate proxy performance changes</span>
</span><span data-line="4"><span class="n">proxy_speeds</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="5">    <span class="s2">&quot;http://proxy1.example.com:8080&quot;</span><span class="p">:</span> <span class="mf">50.0</span><span class="p">,</span>   <span class="c1"># Fast</span>
</span><span data-line="6">    <span class="s2">&quot;http://proxy2.example.com:8080&quot;</span><span class="p">:</span> <span class="mf">200.0</span><span class="p">,</span>  <span class="c1"># Medium</span>
</span><span data-line="7">    <span class="s2">&quot;http://proxy3.example.com:8080&quot;</span><span class="p">:</span> <span class="mf">500.0</span><span class="p">,</span>  <span class="c1"># Slow</span>
</span><span data-line="8"><span class="p">}</span>
</span><span data-line="9">
</span><span data-line="10"><span class="c1"># Phase 1: Initial performance profile</span>
</span><span data-line="11"><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
</span><span data-line="12">    <span class="n">proxy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>
</span><span data-line="13">    <span class="n">response_time</span> <span class="o">=</span> <span class="n">proxy_speeds</span><span class="p">[</span><span class="n">proxy</span><span class="o">.</span><span class="n">url</span><span class="p">]</span>
</span><span data-line="14">    <span class="n">strategy</span><span class="o">.</span><span class="n">record_result</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">response_time_ms</span><span class="o">=</span><span class="n">response_time</span><span class="p">)</span>
</span><span data-line="15">
</span><span data-line="16"><span class="c1"># Phase 2: Proxy 3 improves dramatically</span>
</span><span data-line="17"><span class="n">proxy_speeds</span><span class="p">[</span><span class="s2">&quot;http://proxy3.example.com:8080&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">30.0</span>  <span class="c1"># Now fastest!</span>
</span><span data-line="18">
</span><span data-line="19"><span class="c1"># Strategy adapts over ~20-30 requests (with alpha=0.2)</span>
</span><span data-line="20"><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">):</span>
</span><span data-line="21">    <span class="n">proxy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>
</span><span data-line="22">    <span class="n">response_time</span> <span class="o">=</span> <span class="n">proxy_speeds</span><span class="p">[</span><span class="n">proxy</span><span class="o">.</span><span class="n">url</span><span class="p">]</span>
</span><span data-line="23">    <span class="n">strategy</span><span class="o">.</span><span class="n">record_result</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">response_time_ms</span><span class="o">=</span><span class="n">response_time</span><span class="p">)</span>
</span><span data-line="24">
</span><span data-line="25"><span class="c1"># Proxy 3 now gets selected most frequently</span>
</span></pre></div>
</div>
</section>
<section id="success-criteria">
<h3><a class="toc-backref" href="#id27" role="doc-backlink">Success Criteria</a><a class="headerlink" href="#success-criteria" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>SC-004:</strong> 15-25% response time reduction vs round-robin</p></li>
<li><p><strong>SC-007:</strong> &lt;5ms selection overhead (meets target at ~9µs)</p></li>
<li><p><strong>Adaptation:</strong> Reacts to speed changes within 20-30 requests (alpha=0.2)</p></li>
</ul>
</section>
</section>
<section id="session-persistence-strategy">
<h2><a class="toc-backref" href="#id28" role="doc-backlink">Session Persistence Strategy</a><a class="headerlink" href="#session-persistence-strategy" title="Link to this heading">¶</a></h2>
<p>Maintains consistent proxy assignment for a session ID across multiple requests. Ensures all requests in a session use the same proxy (sticky sessions).</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Session persistence works well with <a class="reference internal" href="retry-failover.html"><span class="doc">Retry &amp; Failover Guide</span></a> – when a session’s assigned proxy fails, the strategy automatically fails over to a new proxy while maintaining the session binding.</p>
</div>
<section id="id1">
<h3><a class="toc-backref" href="#id29" role="doc-backlink">When to Use</a><a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Stateful web scraping</strong> where cookies/sessions matter</p></li>
<li><p><strong>Shopping cart flows</strong> requiring consistent identity</p></li>
<li><p><strong>API rate limits</strong> tied to IP addresses</p></li>
<li><p><strong>Login workflows</strong> with IP-based security</p></li>
</ul>
</section>
<section id="id2">
<h3><a class="toc-backref" href="#id30" role="doc-backlink">Performance Characteristics</a><a class="headerlink" href="#id2" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Selection overhead:</strong> &lt;1ms (O(1) hash lookup)</p></li>
<li><p><strong>Session capacity:</strong> 10,000 active sessions (default, configurable)</p></li>
<li><p><strong>Memory:</strong> ~200 bytes per session</p></li>
<li><p><strong>Same-proxy guarantee:</strong> 99.9% (SC-005)</p></li>
</ul>
</section>
<section id="id3">
<h3><a class="toc-backref" href="#id31" role="doc-backlink">Configuration</a><a class="headerlink" href="#id3" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl</span><span class="w"> </span><span class="kn">import</span> <span class="n">StrategyConfig</span><span class="p">,</span> <span class="n">SelectionContext</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.strategies</span><span class="w"> </span><span class="kn">import</span> <span class="n">SessionPersistenceStrategy</span>
</span><span data-line="3">
</span><span data-line="4"><span class="c1"># Create strategy with session limits</span>
</span><span data-line="5"><span class="n">strategy</span> <span class="o">=</span> <span class="n">SessionPersistenceStrategy</span><span class="p">(</span>
</span><span data-line="6">    <span class="n">max_sessions</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>           <span class="c1"># Maximum active sessions</span>
</span><span data-line="7">    <span class="n">auto_cleanup_threshold</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>   <span class="c1"># Cleanup frequency</span>
</span><span data-line="8"><span class="p">)</span>
</span><span data-line="9">
</span><span data-line="10"><span class="c1"># Configure session TTL</span>
</span><span data-line="11"><span class="n">config</span> <span class="o">=</span> <span class="n">StrategyConfig</span><span class="p">(</span>
</span><span data-line="12">    <span class="n">session_stickiness_duration_seconds</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>  <span class="c1"># 1 hour TTL</span>
</span><span data-line="13"><span class="p">)</span>
</span><span data-line="14"><span class="n">strategy</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span data-line="15">
</span><span data-line="16"><span class="c1"># Select proxy with session ID</span>
</span><span data-line="17"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="s2">&quot;user-12345&quot;</span><span class="p">)</span>
</span><span data-line="18"><span class="n">proxy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="19">
</span><span data-line="20"><span class="c1"># Subsequent requests with same session ID get same proxy</span>
</span><span data-line="21"><span class="n">context2</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="s2">&quot;user-12345&quot;</span><span class="p">)</span>
</span><span data-line="22"><span class="n">proxy2</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context2</span><span class="p">)</span>
</span><span data-line="23">
</span><span data-line="24"><span class="k">assert</span> <span class="n">proxy</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">proxy2</span><span class="o">.</span><span class="n">id</span>  <span class="c1"># Same proxy!</span>
</span></pre></div>
</div>
</section>
<section id="session-lifecycle">
<h3><a class="toc-backref" href="#id32" role="doc-backlink">Session Lifecycle</a><a class="headerlink" href="#session-lifecycle" title="Link to this heading">¶</a></h3>
<pre  class="mermaid">
        graph LR
    A[New Session ID] --&gt; B{Existing Session?}
    B --&gt;|No| C[Select New Proxy]
    B --&gt;|Yes| D{Proxy Healthy?}
    D --&gt;|Yes| E[Reuse Same Proxy]
    D --&gt;|No| F[Failover: Select New Proxy]
    C --&gt; G[Create Session Record]
    F --&gt; G
    G --&gt; H[Update last_used_at]
    E --&gt; H
    </pre></section>
<section id="session-management">
<h3><a class="toc-backref" href="#id33" role="doc-backlink">Session Management</a><a class="headerlink" href="#session-management" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Get session statistics</span>
</span><span data-line="2"><span class="n">stats</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">get_session_stats</span><span class="p">()</span>
</span><span data-line="3"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Active sessions: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_sessions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;max_sessions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="4">
</span><span data-line="5"><span class="c1"># Manually close session (optional)</span>
</span><span data-line="6"><span class="n">strategy</span><span class="o">.</span><span class="n">close_session</span><span class="p">(</span><span class="s2">&quot;user-12345&quot;</span><span class="p">)</span>
</span><span data-line="7">
</span><span data-line="8"><span class="c1"># Cleanup expired sessions (automatic every 100 operations)</span>
</span><span data-line="9"><span class="n">expired_count</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">cleanup_expired_sessions</span><span class="p">()</span>
</span><span data-line="10"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed </span><span class="si">{</span><span class="n">expired_count</span><span class="si">}</span><span class="s2"> expired sessions&quot;</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="failover-behavior">
<h3><a class="toc-backref" href="#id34" role="doc-backlink">Failover Behavior</a><a class="headerlink" href="#failover-behavior" title="Link to this heading">¶</a></h3>
<p>When the assigned proxy becomes unhealthy, the strategy automatically fails over:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">HealthStatus</span>
</span><span data-line="2">
</span><span data-line="3"><span class="c1"># Session initially assigned to proxy1</span>
</span><span data-line="4"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="s2">&quot;session-abc&quot;</span><span class="p">)</span>
</span><span data-line="5"><span class="n">proxy1</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="6">
</span><span data-line="7"><span class="c1"># Mark proxy1 as dead</span>
</span><span data-line="8"><span class="n">proxy1</span><span class="o">.</span><span class="n">health_status</span> <span class="o">=</span> <span class="n">HealthStatus</span><span class="o">.</span><span class="n">DEAD</span>
</span><span data-line="9">
</span><span data-line="10"><span class="c1"># Failover: strategy assigns new proxy for session</span>
</span><span data-line="11"><span class="n">proxy2</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="12">
</span><span data-line="13"><span class="k">assert</span> <span class="n">proxy2</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">proxy1</span><span class="o">.</span><span class="n">id</span>  <span class="c1"># Different proxy</span>
</span><span data-line="14"><span class="k">assert</span> <span class="n">proxy2</span><span class="o">.</span><span class="n">health_status</span> <span class="o">==</span> <span class="n">HealthStatus</span><span class="o">.</span><span class="n">HEALTHY</span>
</span><span data-line="15">
</span><span data-line="16"><span class="c1"># Future requests continue with proxy2</span>
</span><span data-line="17"><span class="n">proxy3</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="18"><span class="k">assert</span> <span class="n">proxy3</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">proxy2</span><span class="o">.</span><span class="n">id</span>  <span class="c1"># Sticky to new proxy</span>
</span></pre></div>
</div>
</section>
<section id="ttl-and-expiration">
<h3><a class="toc-backref" href="#id35" role="doc-backlink">TTL and Expiration</a><a class="headerlink" href="#ttl-and-expiration" title="Link to this heading">¶</a></h3>
<p>Sessions automatically expire after the configured TTL:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
</span><span data-line="2">
</span><span data-line="3"><span class="c1"># Create session with 5-minute TTL</span>
</span><span data-line="4"><span class="n">config</span> <span class="o">=</span> <span class="n">StrategyConfig</span><span class="p">(</span><span class="n">session_stickiness_duration_seconds</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</span><span data-line="5"><span class="n">strategy</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span data-line="6">
</span><span data-line="7"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="s2">&quot;short-lived&quot;</span><span class="p">)</span>
</span><span data-line="8"><span class="n">proxy1</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="9">
</span><span data-line="10"><span class="c1"># Simulate 6 minutes passing</span>
</span><span data-line="11"><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span data-line="12"><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">360</span><span class="p">)</span>
</span><span data-line="13">
</span><span data-line="14"><span class="c1"># Session expired, new proxy assigned</span>
</span><span data-line="15"><span class="n">proxy2</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="16"><span class="c1"># proxy2 may differ from proxy1 (new session created)</span>
</span></pre></div>
</div>
</section>
<section id="lru-eviction">
<h3><a class="toc-backref" href="#id36" role="doc-backlink">LRU Eviction</a><a class="headerlink" href="#lru-eviction" title="Link to this heading">¶</a></h3>
<p>When <code class="docutils literal notranslate"><span class="pre">max_sessions</span></code> limit is reached, least recently used sessions are evicted:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="n">strategy</span> <span class="o">=</span> <span class="n">SessionPersistenceStrategy</span><span class="p">(</span><span class="n">max_sessions</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span data-line="2">
</span><span data-line="3"><span class="c1"># Create 3 sessions (fills capacity)</span>
</span><span data-line="4"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span data-line="5">    <span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;session-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="6">    <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="7">
</span><span data-line="8"><span class="c1"># Touch session-1 to mark as recently used</span>
</span><span data-line="9"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="s2">&quot;session-1&quot;</span><span class="p">)</span>
</span><span data-line="10"><span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="11">
</span><span data-line="12"><span class="c1"># Create 4th session - evicts session-0 (LRU)</span>
</span><span data-line="13"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="s2">&quot;session-3&quot;</span><span class="p">)</span>
</span><span data-line="14"><span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="15">
</span><span data-line="16"><span class="c1"># session-0 is gone, session-1 and session-2 remain</span>
</span></pre></div>
</div>
</section>
<section id="id4">
<h3><a class="toc-backref" href="#id37" role="doc-backlink">Success Criteria</a><a class="headerlink" href="#id4" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>SC-005:</strong> 99.9% same-proxy guarantee for session requests</p></li>
<li><p><strong>Performance:</strong> &lt;1ms session lookup overhead</p></li>
<li><p><strong>Capacity:</strong> Supports 10,000+ active sessions</p></li>
</ul>
</section>
</section>
<section id="geo-targeted-strategy">
<h2><a class="toc-backref" href="#id38" role="doc-backlink">Geo-Targeted Strategy</a><a class="headerlink" href="#geo-targeted-strategy" title="Link to this heading">¶</a></h2>
<p>Filters proxies by geographical location (country or region) before selection.</p>
<section id="id5">
<h3><a class="toc-backref" href="#id39" role="doc-backlink">When to Use</a><a class="headerlink" href="#id5" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Region-locked content</strong> (streaming, news sites)</p></li>
<li><p><strong>Geo-distributed testing</strong> (CDN behavior, localization)</p></li>
<li><p><strong>Regulatory compliance</strong> (data sovereignty requirements)</p></li>
<li><p><strong>Performance optimization</strong> (select proxies near target servers)</p></li>
</ul>
</section>
<section id="id6">
<h3><a class="toc-backref" href="#id40" role="doc-backlink">Performance Characteristics</a><a class="headerlink" href="#id6" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Selection overhead:</strong> ~2-4ms (O(n) filtering + secondary selection)</p></li>
<li><p><strong>Filter accuracy:</strong> 100% when geo metadata available (SC-006)</p></li>
<li><p><strong>Fallback:</strong> Configurable (use any proxy or strict filtering)</p></li>
</ul>
</section>
<section id="id7">
<h3><a class="toc-backref" href="#id41" role="doc-backlink">Configuration</a><a class="headerlink" href="#id7" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl</span><span class="w"> </span><span class="kn">import</span> <span class="n">StrategyConfig</span><span class="p">,</span> <span class="n">SelectionContext</span><span class="p">,</span> <span class="n">Proxy</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.strategies</span><span class="w"> </span><span class="kn">import</span> <span class="n">GeoTargetedStrategy</span>
</span><span data-line="3">
</span><span data-line="4"><span class="c1"># Create proxies with country codes</span>
</span><span data-line="5"><span class="n">proxies</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="6">    <span class="n">Proxy</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://us-proxy1.com:8080&quot;</span><span class="p">,</span> <span class="n">country_code</span><span class="o">=</span><span class="s2">&quot;US&quot;</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="s2">&quot;California&quot;</span><span class="p">),</span>
</span><span data-line="7">    <span class="n">Proxy</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://us-proxy2.com:8080&quot;</span><span class="p">,</span> <span class="n">country_code</span><span class="o">=</span><span class="s2">&quot;US&quot;</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="s2">&quot;New York&quot;</span><span class="p">),</span>
</span><span data-line="8">    <span class="n">Proxy</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://uk-proxy1.com:8080&quot;</span><span class="p">,</span> <span class="n">country_code</span><span class="o">=</span><span class="s2">&quot;GB&quot;</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="s2">&quot;London&quot;</span><span class="p">),</span>
</span><span data-line="9">    <span class="n">Proxy</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://de-proxy1.com:8080&quot;</span><span class="p">,</span> <span class="n">country_code</span><span class="o">=</span><span class="s2">&quot;DE&quot;</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="s2">&quot;Berlin&quot;</span><span class="p">),</span>
</span><span data-line="10"><span class="p">]</span>
</span><span data-line="11">
</span><span data-line="12"><span class="c1"># Configure strategy</span>
</span><span data-line="13"><span class="n">strategy</span> <span class="o">=</span> <span class="n">GeoTargetedStrategy</span><span class="p">()</span>
</span><span data-line="14"><span class="n">config</span> <span class="o">=</span> <span class="n">StrategyConfig</span><span class="p">(</span>
</span><span data-line="15">    <span class="n">geo_fallback_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>         <span class="c1"># Fallback to any proxy if no match</span>
</span><span data-line="16">    <span class="n">geo_secondary_strategy</span><span class="o">=</span><span class="s2">&quot;round_robin&quot;</span><span class="p">,</span>  <span class="c1"># Selection from filtered set</span>
</span><span data-line="17"><span class="p">)</span>
</span><span data-line="18"><span class="n">strategy</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span data-line="19">
</span><span data-line="20"><span class="c1"># Select US proxy</span>
</span><span data-line="21"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">target_country</span><span class="o">=</span><span class="s2">&quot;US&quot;</span><span class="p">)</span>
</span><span data-line="22"><span class="n">proxy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="23"><span class="k">assert</span> <span class="n">proxy</span><span class="o">.</span><span class="n">country_code</span> <span class="o">==</span> <span class="s2">&quot;US&quot;</span>
</span><span data-line="24">
</span><span data-line="25"><span class="c1"># Select by region (more specific)</span>
</span><span data-line="26"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">target_region</span><span class="o">=</span><span class="s2">&quot;California&quot;</span><span class="p">)</span>
</span><span data-line="27"><span class="n">proxy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="28"><span class="k">assert</span> <span class="n">proxy</span><span class="o">.</span><span class="n">region</span> <span class="o">==</span> <span class="s2">&quot;California&quot;</span>
</span></pre></div>
</div>
</section>
<section id="country-codes">
<h3><a class="toc-backref" href="#id42" role="doc-backlink">Country Codes</a><a class="headerlink" href="#country-codes" title="Link to this heading">¶</a></h3>
<p>Use <strong>ISO 3166-1 alpha-2</strong> country codes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Common country codes</span>
</span><span data-line="2"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">target_country</span><span class="o">=</span><span class="s2">&quot;US&quot;</span><span class="p">)</span>  <span class="c1"># United States</span>
</span><span data-line="3"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">target_country</span><span class="o">=</span><span class="s2">&quot;GB&quot;</span><span class="p">)</span>  <span class="c1"># United Kingdom</span>
</span><span data-line="4"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">target_country</span><span class="o">=</span><span class="s2">&quot;DE&quot;</span><span class="p">)</span>  <span class="c1"># Germany</span>
</span><span data-line="5"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">target_country</span><span class="o">=</span><span class="s2">&quot;FR&quot;</span><span class="p">)</span>  <span class="c1"># France</span>
</span><span data-line="6"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">target_country</span><span class="o">=</span><span class="s2">&quot;JP&quot;</span><span class="p">)</span>  <span class="c1"># Japan</span>
</span><span data-line="7"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">target_country</span><span class="o">=</span><span class="s2">&quot;AU&quot;</span><span class="p">)</span>  <span class="c1"># Australia</span>
</span></pre></div>
</div>
</section>
<section id="filtering-logic">
<h3><a class="toc-backref" href="#id43" role="doc-backlink">Filtering Logic</a><a class="headerlink" href="#filtering-logic" title="Link to this heading">¶</a></h3>
<p>The strategy applies filters in this order:</p>
<ol class="arabic simple">
<li><p><strong>Country filter</strong> (if <code class="docutils literal notranslate"><span class="pre">target_country</span></code> specified) - takes precedence</p></li>
<li><p><strong>Region filter</strong> (if <code class="docutils literal notranslate"><span class="pre">target_region</span></code> specified and no country)</p></li>
<li><p><strong>Failed proxy filter</strong> (excludes <code class="docutils literal notranslate"><span class="pre">failed_proxy_ids</span></code>)</p></li>
<li><p><strong>Fallback</strong> (if no matches and <code class="docutils literal notranslate"><span class="pre">geo_fallback_enabled=True</span></code>)</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">HealthStatus</span>
</span><span data-line="2">
</span><span data-line="3"><span class="c1"># Country takes precedence over region</span>
</span><span data-line="4"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span>
</span><span data-line="5">    <span class="n">target_country</span><span class="o">=</span><span class="s2">&quot;US&quot;</span><span class="p">,</span>      <span class="c1"># Country filter applied</span>
</span><span data-line="6">    <span class="n">target_region</span><span class="o">=</span><span class="s2">&quot;London&quot;</span><span class="p">,</span>   <span class="c1"># Ignored (country specified)</span>
</span><span data-line="7"><span class="p">)</span>
</span><span data-line="8"><span class="n">proxy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="9"><span class="k">assert</span> <span class="n">proxy</span><span class="o">.</span><span class="n">country_code</span> <span class="o">==</span> <span class="s2">&quot;US&quot;</span>  <span class="c1"># Not London/GB</span>
</span><span data-line="10">
</span><span data-line="11"><span class="c1"># Region-only filtering</span>
</span><span data-line="12"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">target_region</span><span class="o">=</span><span class="s2">&quot;London&quot;</span><span class="p">)</span>
</span><span data-line="13"><span class="n">proxy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="14"><span class="k">assert</span> <span class="n">proxy</span><span class="o">.</span><span class="n">region</span> <span class="o">==</span> <span class="s2">&quot;London&quot;</span>
</span></pre></div>
</div>
</section>
<section id="fallback-modes">
<h3><a class="toc-backref" href="#id44" role="doc-backlink">Fallback Modes</a><a class="headerlink" href="#fallback-modes" title="Link to this heading">¶</a></h3>
<p><strong>Enabled fallback</strong> (default):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="n">config</span> <span class="o">=</span> <span class="n">StrategyConfig</span><span class="p">(</span><span class="n">geo_fallback_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="2"><span class="n">strategy</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span data-line="3">
</span><span data-line="4"><span class="c1"># No proxies in Antarctica - falls back to any healthy proxy</span>
</span><span data-line="5"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">target_country</span><span class="o">=</span><span class="s2">&quot;AQ&quot;</span><span class="p">)</span>
</span><span data-line="6"><span class="n">proxy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>  <span class="c1"># Returns any healthy proxy</span>
</span></pre></div>
</div>
<p><strong>Disabled fallback</strong> (strict):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProxyPoolEmptyError</span>
</span><span data-line="2">
</span><span data-line="3"><span class="n">config</span> <span class="o">=</span> <span class="n">StrategyConfig</span><span class="p">(</span><span class="n">geo_fallback_enabled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span data-line="4"><span class="n">strategy</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span data-line="5">
</span><span data-line="6"><span class="c1"># No proxies in Antarctica - raises error</span>
</span><span data-line="7"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">target_country</span><span class="o">=</span><span class="s2">&quot;AQ&quot;</span><span class="p">)</span>
</span><span data-line="8"><span class="k">try</span><span class="p">:</span>
</span><span data-line="9">    <span class="n">proxy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="10"><span class="k">except</span> <span class="n">ProxyPoolEmptyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="11">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No proxies for target location: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="secondary-selection-strategies">
<h3><a class="toc-backref" href="#id45" role="doc-backlink">Secondary Selection Strategies</a><a class="headerlink" href="#secondary-selection-strategies" title="Link to this heading">¶</a></h3>
<p>Choose how to select from the geo-filtered proxy set:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="n">config</span> <span class="o">=</span> <span class="n">StrategyConfig</span><span class="p">(</span>
</span><span data-line="2">    <span class="n">geo_secondary_strategy</span><span class="o">=</span><span class="s2">&quot;round_robin&quot;</span><span class="p">,</span>  <span class="c1"># Default: even distribution</span>
</span><span data-line="3">    <span class="c1"># geo_secondary_strategy=&quot;random&quot;,     # Random selection</span>
</span><span data-line="4">    <span class="c1"># geo_secondary_strategy=&quot;least_used&quot;, # Load balancing</span>
</span><span data-line="5"><span class="p">)</span>
</span><span data-line="6"><span class="n">strategy</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span data-line="7">
</span><span data-line="8"><span class="c1"># Filter to US proxies, then round-robin among them</span>
</span><span data-line="9"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">target_country</span><span class="o">=</span><span class="s2">&quot;US&quot;</span><span class="p">)</span>
</span><span data-line="10"><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
</span><span data-line="11">    <span class="n">proxy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="12">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected: </span><span class="si">{</span><span class="n">proxy</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">proxy</span><span class="o">.</span><span class="n">country_code</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="retry-integration">
<h3><a class="toc-backref" href="#id46" role="doc-backlink">Retry Integration</a><a class="headerlink" href="#retry-integration" title="Link to this heading">¶</a></h3>
<p>Works seamlessly with <a class="reference internal" href="retry-failover.html"><span class="doc">Retry &amp; Failover Guide</span></a> to exclude failed proxies:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># First attempt</span>
</span><span data-line="2"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span>
</span><span data-line="3">    <span class="n">target_country</span><span class="o">=</span><span class="s2">&quot;US&quot;</span><span class="p">,</span>
</span><span data-line="4">    <span class="n">failed_proxy_ids</span><span class="o">=</span><span class="p">[],</span>  <span class="c1"># No failures yet</span>
</span><span data-line="5"><span class="p">)</span>
</span><span data-line="6"><span class="n">proxy1</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="7">
</span><span data-line="8"><span class="c1"># Simulate failure</span>
</span><span data-line="9"><span class="n">strategy</span><span class="o">.</span><span class="n">record_result</span><span class="p">(</span><span class="n">proxy1</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">response_time_ms</span><span class="o">=</span><span class="mf">5000.0</span><span class="p">)</span>
</span><span data-line="10">
</span><span data-line="11"><span class="c1"># Retry with failed proxy excluded</span>
</span><span data-line="12"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span>
</span><span data-line="13">    <span class="n">target_country</span><span class="o">=</span><span class="s2">&quot;US&quot;</span><span class="p">,</span>
</span><span data-line="14">    <span class="n">failed_proxy_ids</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">proxy1</span><span class="o">.</span><span class="n">id</span><span class="p">)],</span>  <span class="c1"># Exclude failed proxy</span>
</span><span data-line="15"><span class="p">)</span>
</span><span data-line="16"><span class="n">proxy2</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="17">
</span><span data-line="18"><span class="k">assert</span> <span class="n">proxy2</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">proxy1</span><span class="o">.</span><span class="n">id</span>  <span class="c1"># Different US proxy</span>
</span><span data-line="19"><span class="k">assert</span> <span class="n">proxy2</span><span class="o">.</span><span class="n">country_code</span> <span class="o">==</span> <span class="s2">&quot;US&quot;</span>
</span></pre></div>
</div>
</section>
<section id="id8">
<h3><a class="toc-backref" href="#id47" role="doc-backlink">Success Criteria</a><a class="headerlink" href="#id8" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>SC-006:</strong> 100% correct region selection when geo data available</p></li>
<li><p><strong>Performance:</strong> &lt;5ms selection overhead (meets target)</p></li>
<li><p><strong>Coverage:</strong> Supports ISO 3166-1 alpha-2 country codes</p></li>
</ul>
</section>
</section>
<section id="cost-aware-strategy">
<h2><a class="toc-backref" href="#id48" role="doc-backlink">Cost-Aware Strategy</a><a class="headerlink" href="#cost-aware-strategy" title="Link to this heading">¶</a></h2>
<p>Prioritizes free proxies over paid ones using weighted random selection based on inverse cost. Lower cost proxies are more likely to be selected, with free proxies (cost = 0.0) receiving a significant boost multiplier.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Free proxies get a default 10x weight boost, making them highly favored while still allowing paid proxies to be selected when needed.</p>
</div>
<section id="id9">
<h3><a class="toc-backref" href="#id49" role="doc-backlink">When to Use</a><a class="headerlink" href="#id9" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Mixed free/paid proxy pools</strong> where cost optimization is important</p></li>
<li><p><strong>High-volume scraping</strong> with budget constraints</p></li>
<li><p><strong>Cost-conscious operations</strong> requiring proxy diversity</p></li>
</ul>
</section>
<section id="id10">
<h3><a class="toc-backref" href="#id50" role="doc-backlink">Configuration</a><a class="headerlink" href="#id10" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncProxyRotator</span><span class="p">,</span> <span class="n">Proxy</span><span class="p">,</span> <span class="n">StrategyConfig</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.strategies</span><span class="w"> </span><span class="kn">import</span> <span class="n">CostAwareStrategy</span>
</span><span data-line="3">
</span><span data-line="4"><span class="c1"># Create cost-aware strategy instance</span>
</span><span data-line="5"><span class="n">strategy</span> <span class="o">=</span> <span class="n">CostAwareStrategy</span><span class="p">()</span>
</span><span data-line="6">
</span><span data-line="7"><span class="k">async</span> <span class="k">with</span> <span class="n">AsyncProxyRotator</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">)</span> <span class="k">as</span> <span class="n">rotator</span><span class="p">:</span>
</span><span data-line="8">    <span class="c1"># Add proxies with cost metadata</span>
</span><span data-line="9">    <span class="k">await</span> <span class="n">rotator</span><span class="o">.</span><span class="n">add_proxy</span><span class="p">(</span><span class="n">Proxy</span><span class="p">(</span>
</span><span data-line="10">        <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://free-proxy1.com:8080&quot;</span><span class="p">,</span>
</span><span data-line="11">        <span class="n">cost_per_request</span><span class="o">=</span><span class="mf">0.0</span>  <span class="c1"># Free</span>
</span><span data-line="12">    <span class="p">))</span>
</span><span data-line="13">    <span class="k">await</span> <span class="n">rotator</span><span class="o">.</span><span class="n">add_proxy</span><span class="p">(</span><span class="n">Proxy</span><span class="p">(</span>
</span><span data-line="14">        <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://cheap-proxy.com:8080&quot;</span><span class="p">,</span>
</span><span data-line="15">        <span class="n">cost_per_request</span><span class="o">=</span><span class="mf">0.01</span>  <span class="c1"># $0.01 per request</span>
</span><span data-line="16">    <span class="p">))</span>
</span><span data-line="17">    <span class="k">await</span> <span class="n">rotator</span><span class="o">.</span><span class="n">add_proxy</span><span class="p">(</span><span class="n">Proxy</span><span class="p">(</span>
</span><span data-line="18">        <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://premium-proxy.com:8080&quot;</span><span class="p">,</span>
</span><span data-line="19">        <span class="n">cost_per_request</span><span class="o">=</span><span class="mf">0.10</span>  <span class="c1"># $0.10 per request</span>
</span><span data-line="20">    <span class="p">))</span>
</span><span data-line="21">
</span><span data-line="22">    <span class="c1"># Free proxy heavily favored (~91% selection probability)</span>
</span><span data-line="23">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
</span><span data-line="24">        <span class="n">proxy</span> <span class="o">=</span> <span class="k">await</span> <span class="n">rotator</span><span class="o">.</span><span class="n">get_proxy</span><span class="p">()</span>
</span><span data-line="25">        <span class="c1"># Likely free-proxy1</span>
</span></pre></div>
</div>
</section>
<section id="weight-calculation">
<h3><a class="toc-backref" href="#id51" role="doc-backlink">Weight Calculation</a><a class="headerlink" href="#weight-calculation" title="Link to this heading">¶</a></h3>
<p>The strategy calculates inverse cost weights:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="n">For</span> <span class="n">free</span> <span class="n">proxy</span> <span class="p">(</span><span class="n">cost</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
</span><span data-line="2">    <span class="n">weight</span> <span class="o">=</span> <span class="n">free_proxy_boost</span> <span class="p">(</span><span class="n">default</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">)</span>
</span><span data-line="3">
</span><span data-line="4"><span class="n">For</span> <span class="n">paid</span> <span class="n">proxy</span> <span class="p">(</span><span class="n">cost</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">):</span>
</span><span data-line="5">    <span class="n">weight</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">cost</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">)</span>
</span><span data-line="6">
</span><span data-line="7"><span class="n">Weights</span> <span class="n">are</span> <span class="n">normalized</span> <span class="n">to</span> <span class="nb">sum</span> <span class="n">to</span> <span class="mf">1.0</span>
</span></pre></div>
</div>
</section>
<section id="cost-threshold-filtering">
<h3><a class="toc-backref" href="#id52" role="doc-backlink">Cost Threshold Filtering</a><a class="headerlink" href="#cost-threshold-filtering" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncProxyRotator</span><span class="p">,</span> <span class="n">Proxy</span><span class="p">,</span> <span class="n">StrategyConfig</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.strategies</span><span class="w"> </span><span class="kn">import</span> <span class="n">CostAwareStrategy</span>
</span><span data-line="3">
</span><span data-line="4"><span class="c1"># Configure strategy with cost thresholds</span>
</span><span data-line="5"><span class="n">config</span> <span class="o">=</span> <span class="n">StrategyConfig</span><span class="p">(</span>
</span><span data-line="6">    <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
</span><span data-line="7">        <span class="s2">&quot;max_cost_per_request&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>  <span class="c1"># Filter out expensive proxies</span>
</span><span data-line="8">        <span class="s2">&quot;free_proxy_boost&quot;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span>      <span class="c1"># Weight multiplier for free proxies</span>
</span><span data-line="9">    <span class="p">}</span>
</span><span data-line="10"><span class="p">)</span>
</span><span data-line="11">
</span><span data-line="12"><span class="n">strategy</span> <span class="o">=</span> <span class="n">CostAwareStrategy</span><span class="p">()</span>
</span><span data-line="13"><span class="n">strategy</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span data-line="14">
</span><span data-line="15"><span class="k">async</span> <span class="k">with</span> <span class="n">AsyncProxyRotator</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">)</span> <span class="k">as</span> <span class="n">rotator</span><span class="p">:</span>
</span><span data-line="16">    <span class="k">await</span> <span class="n">rotator</span><span class="o">.</span><span class="n">add_proxy</span><span class="p">(</span><span class="n">Proxy</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://cheap.com:8080&quot;</span><span class="p">,</span> <span class="n">cost_per_request</span><span class="o">=</span><span class="mf">0.01</span><span class="p">))</span>
</span><span data-line="17">    <span class="k">await</span> <span class="n">rotator</span><span class="o">.</span><span class="n">add_proxy</span><span class="p">(</span><span class="n">Proxy</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://expensive.com:8080&quot;</span><span class="p">,</span> <span class="n">cost_per_request</span><span class="o">=</span><span class="mf">0.20</span><span class="p">))</span>
</span><span data-line="18">
</span><span data-line="19">    <span class="c1"># expensive-proxy filtered out (exceeds max_cost_per_request)</span>
</span><span data-line="20">    <span class="n">proxy</span> <span class="o">=</span> <span class="k">await</span> <span class="n">rotator</span><span class="o">.</span><span class="n">get_proxy</span><span class="p">()</span>
</span><span data-line="21">    <span class="k">assert</span> <span class="n">proxy</span><span class="o">.</span><span class="n">cost_per_request</span> <span class="o">&lt;=</span> <span class="mf">0.05</span>
</span></pre></div>
</div>
</section>
<section id="best-practices">
<h3><a class="toc-backref" href="#id53" role="doc-backlink">Best Practices</a><a class="headerlink" href="#best-practices" title="Link to this heading">¶</a></h3>
<p><strong>Configuration tips:</strong></p>
<ul class="simple">
<li><p>Set <code class="docutils literal notranslate"><span class="pre">max_cost_per_request</span></code> to hard budget limit</p></li>
<li><p>Adjust <code class="docutils literal notranslate"><span class="pre">free_proxy_boost</span></code> based on free proxy reliability (lower if unreliable)</p></li>
<li><p>Combine with <code class="docutils literal notranslate"><span class="pre">PerformanceBasedStrategy</span></code> via <code class="docutils literal notranslate"><span class="pre">CompositeStrategy</span></code> for cost + speed optimization</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncProxyRotator</span><span class="p">,</span> <span class="n">StrategyConfig</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.strategies</span><span class="w"> </span><span class="kn">import</span> <span class="n">CostAwareStrategy</span>
</span><span data-line="3">
</span><span data-line="4"><span class="c1"># Recommended production configuration</span>
</span><span data-line="5"><span class="n">config</span> <span class="o">=</span> <span class="n">StrategyConfig</span><span class="p">(</span>
</span><span data-line="6">    <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
</span><span data-line="7">        <span class="s2">&quot;max_cost_per_request&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>  <span class="c1"># $0.05 budget ceiling</span>
</span><span data-line="8">        <span class="s2">&quot;free_proxy_boost&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>       <span class="c1"># Lower boost if free proxies unreliable</span>
</span><span data-line="9">    <span class="p">}</span>
</span><span data-line="10"><span class="p">)</span>
</span><span data-line="11">
</span><span data-line="12"><span class="n">strategy</span> <span class="o">=</span> <span class="n">CostAwareStrategy</span><span class="p">()</span>
</span><span data-line="13"><span class="n">strategy</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span data-line="14">
</span><span data-line="15"><span class="k">async</span> <span class="k">with</span> <span class="n">AsyncProxyRotator</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">)</span> <span class="k">as</span> <span class="n">rotator</span><span class="p">:</span>
</span><span data-line="16">    <span class="c1"># Add proxies with cost metadata</span>
</span><span data-line="17">    <span class="k">pass</span>
</span></pre></div>
</div>
</section>
</section>
<section id="composite-strategy">
<h2><a class="toc-backref" href="#id54" role="doc-backlink">Composite Strategy</a><a class="headerlink" href="#composite-strategy" title="Link to this heading">¶</a></h2>
<p>Composes multiple strategies into a filter → select pipeline. Apply filtering strategies first, then selection strategy on the filtered set.</p>
<section id="id11">
<h3><a class="toc-backref" href="#id55" role="doc-backlink">When to Use</a><a class="headerlink" href="#id11" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Multi-criteria selection</strong> (e.g., geo + performance)</p></li>
<li><p><strong>Complex business logic</strong> requiring multiple stages</p></li>
<li><p><strong>Reusable filter chains</strong> for different use cases</p></li>
</ul>
</section>
<section id="id12">
<h3><a class="toc-backref" href="#id56" role="doc-backlink">Performance Characteristics</a><a class="headerlink" href="#id12" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Selection overhead:</strong> Sum of filter + selector times (target &lt;5ms total)</p></li>
<li><p><strong>Flexibility:</strong> Arbitrary filter chains</p></li>
<li><p><strong>Composability:</strong> Can nest composite strategies</p></li>
</ul>
</section>
<section id="architecture">
<h3><a class="toc-backref" href="#id57" role="doc-backlink">Architecture</a><a class="headerlink" href="#architecture" title="Link to this heading">¶</a></h3>
<pre  class="mermaid">
        graph LR
    A[Proxy Pool] --&gt; B[Filter 1: Geo]
    B --&gt; C[Filter 2: ...]
    C --&gt; D[Selector: Performance]
    D --&gt; E[Selected Proxy]
    </pre></section>
<section id="basic-composition">
<h3><a class="toc-backref" href="#id58" role="doc-backlink">Basic Composition</a><a class="headerlink" href="#basic-composition" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl</span><span class="w"> </span><span class="kn">import</span> <span class="n">SelectionContext</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.strategies</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span data-line="3">    <span class="n">CompositeStrategy</span><span class="p">,</span>
</span><span data-line="4">    <span class="n">GeoTargetedStrategy</span><span class="p">,</span>
</span><span data-line="5">    <span class="n">PerformanceBasedStrategy</span><span class="p">,</span>
</span><span data-line="6"><span class="p">)</span>
</span><span data-line="7">
</span><span data-line="8"><span class="c1"># Geo-filter + performance-based selection</span>
</span><span data-line="9"><span class="n">strategy</span> <span class="o">=</span> <span class="n">CompositeStrategy</span><span class="p">(</span>
</span><span data-line="10">    <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="n">GeoTargetedStrategy</span><span class="p">()],</span>
</span><span data-line="11">    <span class="n">selector</span><span class="o">=</span><span class="n">PerformanceBasedStrategy</span><span class="p">(),</span>
</span><span data-line="12"><span class="p">)</span>
</span><span data-line="13">
</span><span data-line="14"><span class="c1"># Select fastest US proxy</span>
</span><span data-line="15"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">target_country</span><span class="o">=</span><span class="s2">&quot;US&quot;</span><span class="p">)</span>
</span><span data-line="16"><span class="n">proxy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="17">
</span><span data-line="18"><span class="k">assert</span> <span class="n">proxy</span><span class="o">.</span><span class="n">country_code</span> <span class="o">==</span> <span class="s2">&quot;US&quot;</span>
</span><span data-line="19"><span class="c1"># proxy is also the fastest US proxy based on EMA</span>
</span></pre></div>
</div>
</section>
<section id="common-patterns">
<h3><a class="toc-backref" href="#id59" role="doc-backlink">Common Patterns</a><a class="headerlink" href="#common-patterns" title="Link to this heading">¶</a></h3>
<p><strong>Pattern 1: Geo + Performance</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Select fastest proxy in target region</span>
</span><span data-line="2"><span class="n">geo_filter</span> <span class="o">=</span> <span class="n">GeoTargetedStrategy</span><span class="p">()</span>
</span><span data-line="3"><span class="n">perf_selector</span> <span class="o">=</span> <span class="n">PerformanceBasedStrategy</span><span class="p">()</span>
</span><span data-line="4">
</span><span data-line="5"><span class="n">strategy</span> <span class="o">=</span> <span class="n">CompositeStrategy</span><span class="p">(</span>
</span><span data-line="6">    <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="n">geo_filter</span><span class="p">],</span>
</span><span data-line="7">    <span class="n">selector</span><span class="o">=</span><span class="n">perf_selector</span><span class="p">,</span>
</span><span data-line="8"><span class="p">)</span>
</span><span data-line="9">
</span><span data-line="10"><span class="c1"># Get fastest UK proxy</span>
</span><span data-line="11"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">target_country</span><span class="o">=</span><span class="s2">&quot;GB&quot;</span><span class="p">)</span>
</span><span data-line="12"><span class="n">proxy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span></pre></div>
</div>
<p><strong>Pattern 2: Geo + Load Balancing</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Evenly distribute load within region</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.strategies</span><span class="w"> </span><span class="kn">import</span> <span class="n">LeastUsedStrategy</span>
</span><span data-line="3">
</span><span data-line="4"><span class="n">strategy</span> <span class="o">=</span> <span class="n">CompositeStrategy</span><span class="p">(</span>
</span><span data-line="5">    <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="n">GeoTargetedStrategy</span><span class="p">()],</span>
</span><span data-line="6">    <span class="n">selector</span><span class="o">=</span><span class="n">LeastUsedStrategy</span><span class="p">(),</span>
</span><span data-line="7"><span class="p">)</span>
</span><span data-line="8">
</span><span data-line="9"><span class="c1"># Balance load across US proxies</span>
</span><span data-line="10"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">target_country</span><span class="o">=</span><span class="s2">&quot;US&quot;</span><span class="p">)</span>
</span><span data-line="11"><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
</span><span data-line="12">    <span class="n">proxy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="13">    <span class="n">proxy</span><span class="o">.</span><span class="n">start_request</span><span class="p">()</span>
</span></pre></div>
</div>
<p><strong>Pattern 3: Multi-Stage Filtering</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Multiple filters applied sequentially</span>
</span><span data-line="2"><span class="n">filter1</span> <span class="o">=</span> <span class="n">GeoTargetedStrategy</span><span class="p">()</span>
</span><span data-line="3"><span class="n">filter2</span> <span class="o">=</span> <span class="n">CustomHealthFilter</span><span class="p">()</span>  <span class="c1"># Your custom filter</span>
</span><span data-line="4">
</span><span data-line="5"><span class="n">strategy</span> <span class="o">=</span> <span class="n">CompositeStrategy</span><span class="p">(</span>
</span><span data-line="6">    <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="n">filter1</span><span class="p">,</span> <span class="n">filter2</span><span class="p">],</span>
</span><span data-line="7">    <span class="n">selector</span><span class="o">=</span><span class="n">PerformanceBasedStrategy</span><span class="p">(),</span>
</span><span data-line="8"><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="configuration-from-dict">
<h3><a class="toc-backref" href="#id60" role="doc-backlink">Configuration from Dict</a><a class="headerlink" href="#configuration-from-dict" title="Link to this heading">¶</a></h3>
<p>Create composite strategies from configuration:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="2">    <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;geo-targeted&quot;</span><span class="p">],</span>
</span><span data-line="3">    <span class="s2">&quot;selector&quot;</span><span class="p">:</span> <span class="s2">&quot;performance-based&quot;</span><span class="p">,</span>
</span><span data-line="4"><span class="p">}</span>
</span><span data-line="5">
</span><span data-line="6"><span class="n">strategy</span> <span class="o">=</span> <span class="n">CompositeStrategy</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span data-line="7">
</span><span data-line="8"><span class="c1"># Equivalent to:</span>
</span><span data-line="9"><span class="c1"># strategy = CompositeStrategy(</span>
</span><span data-line="10"><span class="c1">#     filters=[GeoTargetedStrategy()],</span>
</span><span data-line="11"><span class="c1">#     selector=PerformanceBasedStrategy(),</span>
</span><span data-line="12"><span class="c1"># )</span>
</span></pre></div>
</div>
</section>
<section id="validation-example">
<h3><a class="toc-backref" href="#id61" role="doc-backlink">Validation Example</a><a class="headerlink" href="#validation-example" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl</span><span class="w"> </span><span class="kn">import</span> <span class="n">Proxy</span><span class="p">,</span> <span class="n">ProxyPool</span><span class="p">,</span> <span class="n">HealthStatus</span><span class="p">,</span> <span class="n">SelectionContext</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.strategies</span><span class="w"> </span><span class="kn">import</span> <span class="n">CompositeStrategy</span><span class="p">,</span> <span class="n">GeoTargetedStrategy</span><span class="p">,</span> <span class="n">PerformanceBasedStrategy</span>
</span><span data-line="3"><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>
</span><span data-line="4">
</span><span data-line="5"><span class="c1"># Create diverse pool</span>
</span><span data-line="6"><span class="n">pool</span> <span class="o">=</span> <span class="n">ProxyPool</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;global-pool&quot;</span><span class="p">)</span>
</span><span data-line="7">
</span><span data-line="8"><span class="n">us_proxies</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="9">    <span class="n">Proxy</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;http://us</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.com:8080&quot;</span><span class="p">,</span> <span class="n">country_code</span><span class="o">=</span><span class="s2">&quot;US&quot;</span><span class="p">,</span>
</span><span data-line="10">          <span class="n">health_status</span><span class="o">=</span><span class="n">HealthStatus</span><span class="o">.</span><span class="n">HEALTHY</span><span class="p">)</span>
</span><span data-line="11">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span data-line="12"><span class="p">]</span>
</span><span data-line="13"><span class="n">uk_proxies</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="14">    <span class="n">Proxy</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;http://uk</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.com:8080&quot;</span><span class="p">,</span> <span class="n">country_code</span><span class="o">=</span><span class="s2">&quot;GB&quot;</span><span class="p">,</span>
</span><span data-line="15">          <span class="n">health_status</span><span class="o">=</span><span class="n">HealthStatus</span><span class="o">.</span><span class="n">HEALTHY</span><span class="p">)</span>
</span><span data-line="16">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span data-line="17"><span class="p">]</span>
</span><span data-line="18">
</span><span data-line="19"><span class="c1"># Different performance profiles</span>
</span><span data-line="20"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">us_proxies</span><span class="p">):</span>
</span><span data-line="21">    <span class="n">pool</span><span class="o">.</span><span class="n">add_proxy</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
</span><span data-line="22">    <span class="n">proxy</span><span class="o">.</span><span class="n">start_request</span><span class="p">()</span>
</span><span data-line="23">    <span class="n">proxy</span><span class="o">.</span><span class="n">complete_request</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">response_time_ms</span><span class="o">=</span><span class="mf">100.0</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
</span><span data-line="24">
</span><span data-line="25"><span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">uk_proxies</span><span class="p">:</span>
</span><span data-line="26">    <span class="n">pool</span><span class="o">.</span><span class="n">add_proxy</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
</span><span data-line="27">    <span class="n">proxy</span><span class="o">.</span><span class="n">start_request</span><span class="p">()</span>
</span><span data-line="28">    <span class="n">proxy</span><span class="o">.</span><span class="n">complete_request</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">response_time_ms</span><span class="o">=</span><span class="mf">200.0</span><span class="p">)</span>
</span><span data-line="29">
</span><span data-line="30"><span class="c1"># Use composite strategy</span>
</span><span data-line="31"><span class="n">strategy</span> <span class="o">=</span> <span class="n">CompositeStrategy</span><span class="p">(</span>
</span><span data-line="32">    <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="n">GeoTargetedStrategy</span><span class="p">()],</span>
</span><span data-line="33">    <span class="n">selector</span><span class="o">=</span><span class="n">PerformanceBasedStrategy</span><span class="p">(),</span>
</span><span data-line="34"><span class="p">)</span>
</span><span data-line="35">
</span><span data-line="36"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">target_country</span><span class="o">=</span><span class="s2">&quot;US&quot;</span><span class="p">)</span>
</span><span data-line="37">
</span><span data-line="38"><span class="c1"># Make selections - should favor faster US proxies</span>
</span><span data-line="39"><span class="n">selections</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
</span><span data-line="40"><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
</span><span data-line="41">    <span class="n">proxy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="42">    <span class="n">selections</span><span class="p">[</span><span class="n">proxy</span><span class="o">.</span><span class="n">url</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span data-line="43">
</span><span data-line="44"><span class="c1"># Validate: all US proxies, fastest selected most</span>
</span><span data-line="45"><span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="s2">&quot;us&quot;</span> <span class="ow">in</span> <span class="n">url</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">selections</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span data-line="46"><span class="k">assert</span> <span class="n">selections</span><span class="p">[</span><span class="s2">&quot;http://us0.com:8080&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">selections</span><span class="p">[</span><span class="s2">&quot;http://us4.com:8080&quot;</span><span class="p">]</span>
</span></pre></div>
</div>
</section>
<section id="performance-considerations">
<h3><a class="toc-backref" href="#id62" role="doc-backlink">Performance Considerations</a><a class="headerlink" href="#performance-considerations" title="Link to this heading">¶</a></h3>
<p>The composite strategy must still meet the &lt;5ms overhead target:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl</span><span class="w"> </span><span class="kn">import</span> <span class="n">Proxy</span><span class="p">,</span> <span class="n">ProxyPool</span><span class="p">,</span> <span class="n">HealthStatus</span><span class="p">,</span> <span class="n">SelectionContext</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.strategies</span><span class="w"> </span><span class="kn">import</span> <span class="n">CompositeStrategy</span><span class="p">,</span> <span class="n">GeoTargetedStrategy</span><span class="p">,</span> <span class="n">PerformanceBasedStrategy</span>
</span><span data-line="3"><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span data-line="4">
</span><span data-line="5"><span class="c1"># Create large pool</span>
</span><span data-line="6"><span class="n">pool</span> <span class="o">=</span> <span class="n">ProxyPool</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;perf-test&quot;</span><span class="p">)</span>
</span><span data-line="7"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
</span><span data-line="8">    <span class="n">country</span> <span class="o">=</span> <span class="s2">&quot;US&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="s2">&quot;GB&quot;</span>
</span><span data-line="9">    <span class="n">proxy</span> <span class="o">=</span> <span class="n">Proxy</span><span class="p">(</span>
</span><span data-line="10">        <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;http://proxy</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.com:8080&quot;</span><span class="p">,</span>
</span><span data-line="11">        <span class="n">country_code</span><span class="o">=</span><span class="n">country</span><span class="p">,</span>
</span><span data-line="12">        <span class="n">health_status</span><span class="o">=</span><span class="n">HealthStatus</span><span class="o">.</span><span class="n">HEALTHY</span><span class="p">,</span>
</span><span data-line="13">    <span class="p">)</span>
</span><span data-line="14">    <span class="n">proxy</span><span class="o">.</span><span class="n">start_request</span><span class="p">()</span>
</span><span data-line="15">    <span class="n">proxy</span><span class="o">.</span><span class="n">complete_request</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">response_time_ms</span><span class="o">=</span><span class="mf">100.0</span><span class="p">)</span>
</span><span data-line="16">    <span class="n">pool</span><span class="o">.</span><span class="n">add_proxy</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
</span><span data-line="17">
</span><span data-line="18"><span class="n">strategy</span> <span class="o">=</span> <span class="n">CompositeStrategy</span><span class="p">(</span>
</span><span data-line="19">    <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="n">GeoTargetedStrategy</span><span class="p">()],</span>
</span><span data-line="20">    <span class="n">selector</span><span class="o">=</span><span class="n">PerformanceBasedStrategy</span><span class="p">(),</span>
</span><span data-line="21"><span class="p">)</span>
</span><span data-line="22">
</span><span data-line="23"><span class="c1"># Measure performance</span>
</span><span data-line="24"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">target_country</span><span class="o">=</span><span class="s2">&quot;US&quot;</span><span class="p">)</span>
</span><span data-line="25"><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span data-line="26">
</span><span data-line="27"><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
</span><span data-line="28">    <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="29">
</span><span data-line="30"><span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
</span><span data-line="31"><span class="n">avg_ms</span> <span class="o">=</span> <span class="n">elapsed_ms</span> <span class="o">/</span> <span class="mi">1000</span>
</span><span data-line="32">
</span><span data-line="33"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average selection time: </span><span class="si">{</span><span class="n">avg_ms</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">ms&quot;</span><span class="p">)</span>
</span><span data-line="34"><span class="k">assert</span> <span class="n">avg_ms</span> <span class="o">&lt;</span> <span class="mf">5.0</span>  <span class="c1"># Meets SC-007</span>
</span></pre></div>
</div>
</section>
<section id="id13">
<h3><a class="toc-backref" href="#id63" role="doc-backlink">Success Criteria</a><a class="headerlink" href="#id13" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>SC-007:</strong> &lt;5ms total selection overhead</p></li>
<li><p><strong>SC-009:</strong> Strategy composition completes in &lt;100ms</p></li>
<li><p><strong>Correctness:</strong> All filters applied in order</p></li>
</ul>
</section>
</section>
<section id="strategy-registry">
<h2><a class="toc-backref" href="#id64" role="doc-backlink">Strategy Registry</a><a class="headerlink" href="#strategy-registry" title="Link to this heading">¶</a></h2>
<p>Register custom strategies for reuse and configuration-driven instantiation.</p>
<section id="registration">
<h3><a class="toc-backref" href="#id65" role="doc-backlink">Registration</a><a class="headerlink" href="#registration" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.strategies</span><span class="w"> </span><span class="kn">import</span> <span class="n">StrategyRegistry</span>
</span><span data-line="2">
</span><span data-line="3"><span class="c1"># Define custom strategy</span>
</span><span data-line="4"><span class="k">class</span><span class="w"> </span><span class="nc">MyCustomStrategy</span><span class="p">:</span>
</span><span data-line="5">    <span class="k">def</span><span class="w"> </span><span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span data-line="6">        <span class="c1"># Custom selection logic</span>
</span><span data-line="7">        <span class="n">proxies</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">get_healthy_proxies</span><span class="p">()</span>
</span><span data-line="8">        <span class="k">return</span> <span class="n">proxies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">proxies</span> <span class="k">else</span> <span class="kc">None</span>
</span><span data-line="9">
</span><span data-line="10">    <span class="k">def</span><span class="w"> </span><span class="nf">record_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="n">response_time_ms</span><span class="p">):</span>
</span><span data-line="11">        <span class="c1"># Track results</span>
</span><span data-line="12">        <span class="k">pass</span>
</span><span data-line="13">
</span><span data-line="14"><span class="c1"># Register strategy</span>
</span><span data-line="15"><span class="n">registry</span> <span class="o">=</span> <span class="n">StrategyRegistry</span><span class="p">()</span>
</span><span data-line="16"><span class="n">registry</span><span class="o">.</span><span class="n">register_strategy</span><span class="p">(</span><span class="s2">&quot;my-custom&quot;</span><span class="p">,</span> <span class="n">MyCustomStrategy</span><span class="p">)</span>
</span><span data-line="17">
</span><span data-line="18"><span class="c1"># Retrieve and use</span>
</span><span data-line="19"><span class="n">strategy_class</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">get_strategy</span><span class="p">(</span><span class="s2">&quot;my-custom&quot;</span><span class="p">)</span>
</span><span data-line="20"><span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy_class</span><span class="p">()</span>
</span></pre></div>
</div>
</section>
<section id="validation">
<h3><a class="toc-backref" href="#id66" role="doc-backlink">Validation</a><a class="headerlink" href="#validation" title="Link to this heading">¶</a></h3>
<p>The registry validates strategies implement the <code class="docutils literal notranslate"><span class="pre">RotationStrategy</span></code> protocol:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Missing required methods</span>
</span><span data-line="2"><span class="k">class</span><span class="w"> </span><span class="nc">BadStrategy</span><span class="p">:</span>
</span><span data-line="3">    <span class="k">pass</span>
</span><span data-line="4">
</span><span data-line="5"><span class="k">try</span><span class="p">:</span>
</span><span data-line="6">    <span class="n">registry</span><span class="o">.</span><span class="n">register_strategy</span><span class="p">(</span><span class="s2">&quot;bad&quot;</span><span class="p">,</span> <span class="n">BadStrategy</span><span class="p">)</span>
</span><span data-line="7"><span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="8">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="9">    <span class="c1"># &quot;Strategy BadStrategy missing required methods: select, record_result&quot;</span>
</span></pre></div>
</div>
</section>
<section id="thread-safety">
<h3><a class="toc-backref" href="#id67" role="doc-backlink">Thread Safety</a><a class="headerlink" href="#thread-safety" title="Link to this heading">¶</a></h3>
<p>The registry is a thread-safe singleton:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Multiple threads can safely register/retrieve strategies</span>
</span><span data-line="2"><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
</span><span data-line="3">
</span><span data-line="4"><span class="k">def</span><span class="w"> </span><span class="nf">register_strategies</span><span class="p">():</span>
</span><span data-line="5">    <span class="n">registry</span> <span class="o">=</span> <span class="n">StrategyRegistry</span><span class="p">()</span>  <span class="c1"># Same instance</span>
</span><span data-line="6">    <span class="n">registry</span><span class="o">.</span><span class="n">register_strategy</span><span class="p">(</span><span class="s2">&quot;thread-safe&quot;</span><span class="p">,</span> <span class="n">MyCustomStrategy</span><span class="p">)</span>
</span><span data-line="7">
</span><span data-line="8"><span class="n">threads</span> <span class="o">=</span> <span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">register_strategies</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
</span><span data-line="9"><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
</span><span data-line="10">    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span data-line="11"><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
</span><span data-line="12">    <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span data-line="13">
</span><span data-line="14"><span class="c1"># All registrations succeed (last one wins if duplicate names)</span>
</span></pre></div>
</div>
</section>
<section id="listing-strategies">
<h3><a class="toc-backref" href="#id68" role="doc-backlink">Listing Strategies</a><a class="headerlink" href="#listing-strategies" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="n">registry</span> <span class="o">=</span> <span class="n">StrategyRegistry</span><span class="p">()</span>
</span><span data-line="2">
</span><span data-line="3"><span class="c1"># List all registered strategies</span>
</span><span data-line="4"><span class="n">strategies</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">list_strategies</span><span class="p">()</span>
</span><span data-line="5"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Available strategies: </span><span class="si">{</span><span class="n">strategies</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="6">
</span><span data-line="7"><span class="c1"># Unregister a strategy</span>
</span><span data-line="8"><span class="n">registry</span><span class="o">.</span><span class="n">unregister_strategy</span><span class="p">(</span><span class="s2">&quot;my-custom&quot;</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
</section>
<section id="selectioncontext">
<h2><a class="toc-backref" href="#id69" role="doc-backlink">SelectionContext</a><a class="headerlink" href="#selectioncontext" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">SelectionContext</span></code> model provides contextual information for intelligent proxy selection.</p>
<section id="fields">
<h3><a class="toc-backref" href="#id70" role="doc-backlink">Fields</a><a class="headerlink" href="#fields" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl</span><span class="w"> </span><span class="kn">import</span> <span class="n">SelectionContext</span>
</span><span data-line="2">
</span><span data-line="3"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span>
</span><span data-line="4">    <span class="c1"># Session tracking</span>
</span><span data-line="5">    <span class="n">session_id</span><span class="o">=</span><span class="s2">&quot;user-12345&quot;</span><span class="p">,</span>
</span><span data-line="6">
</span><span data-line="7">    <span class="c1"># Geo-targeting</span>
</span><span data-line="8">    <span class="n">target_country</span><span class="o">=</span><span class="s2">&quot;US&quot;</span><span class="p">,</span>
</span><span data-line="9">    <span class="n">target_region</span><span class="o">=</span><span class="s2">&quot;California&quot;</span><span class="p">,</span>
</span><span data-line="10">
</span><span data-line="11">    <span class="c1"># Request metadata</span>
</span><span data-line="12">    <span class="n">target_url</span><span class="o">=</span><span class="s2">&quot;https://api.example.com&quot;</span><span class="p">,</span>
</span><span data-line="13">    <span class="n">request_priority</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span data-line="14">    <span class="n">timeout_ms</span><span class="o">=</span><span class="mf">5000.0</span><span class="p">,</span>
</span><span data-line="15">
</span><span data-line="16">    <span class="c1"># Retry tracking</span>
</span><span data-line="17">    <span class="n">failed_proxy_ids</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;uuid-1&quot;</span><span class="p">,</span> <span class="s2">&quot;uuid-2&quot;</span><span class="p">],</span>
</span><span data-line="18">    <span class="n">attempt_number</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span data-line="19">
</span><span data-line="20">    <span class="c1"># Custom data</span>
</span><span data-line="21">    <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_tier&quot;</span><span class="p">:</span> <span class="s2">&quot;premium&quot;</span><span class="p">},</span>
</span><span data-line="22"><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="usage-with-strategies">
<h3><a class="toc-backref" href="#id71" role="doc-backlink">Usage with Strategies</a><a class="headerlink" href="#usage-with-strategies" title="Link to this heading">¶</a></h3>
<p>All advanced strategies accept <code class="docutils literal notranslate"><span class="pre">SelectionContext</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Session persistence requires session_id</span>
</span><span data-line="2"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="s2">&quot;session-abc&quot;</span><span class="p">)</span>
</span><span data-line="3"><span class="n">proxy</span> <span class="o">=</span> <span class="n">session_strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="4">
</span><span data-line="5"><span class="c1"># Geo-targeting uses target_country/target_region</span>
</span><span data-line="6"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">target_country</span><span class="o">=</span><span class="s2">&quot;US&quot;</span><span class="p">)</span>
</span><span data-line="7"><span class="n">proxy</span> <span class="o">=</span> <span class="n">geo_strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="8">
</span><span data-line="9"><span class="c1"># Retry logic uses failed_proxy_ids</span>
</span><span data-line="10"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span>
</span><span data-line="11">    <span class="n">failed_proxy_ids</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">failed_proxy</span><span class="o">.</span><span class="n">id</span><span class="p">)],</span>
</span><span data-line="12">    <span class="n">attempt_number</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span data-line="13"><span class="p">)</span>
</span><span data-line="14"><span class="n">proxy</span> <span class="o">=</span> <span class="n">any_strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
</section>
<section id="strategyconfig">
<h2><a class="toc-backref" href="#id72" role="doc-backlink">StrategyConfig</a><a class="headerlink" href="#strategyconfig" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">StrategyConfig</span></code> model provides configuration for all strategies.</p>
<section id="id14">
<h3><a class="toc-backref" href="#id73" role="doc-backlink">Fields</a><a class="headerlink" href="#id14" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl</span><span class="w"> </span><span class="kn">import</span> <span class="n">StrategyConfig</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.strategies</span><span class="w"> </span><span class="kn">import</span> <span class="n">PerformanceBasedStrategy</span>
</span><span data-line="3">
</span><span data-line="4"><span class="n">config</span> <span class="o">=</span> <span class="n">StrategyConfig</span><span class="p">(</span>
</span><span data-line="5">    <span class="c1"># Weighted strategy</span>
</span><span data-line="6">    <span class="n">weights</span><span class="o">=</span><span class="p">{</span>
</span><span data-line="7">        <span class="s2">&quot;http://proxy1.com:8080&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span data-line="8">        <span class="s2">&quot;http://proxy2.com:8080&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
</span><span data-line="9">        <span class="s2">&quot;http://proxy3.com:8080&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
</span><span data-line="10">    <span class="p">},</span>
</span><span data-line="11">
</span><span data-line="12">    <span class="c1"># Performance-based strategy</span>
</span><span data-line="13">    <span class="n">ema_alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>  <span class="c1"># EMA smoothing factor</span>
</span><span data-line="14">
</span><span data-line="15">    <span class="c1"># Session persistence</span>
</span><span data-line="16">    <span class="n">session_stickiness_duration_seconds</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>  <span class="c1"># 1 hour TTL</span>
</span><span data-line="17">
</span><span data-line="18">    <span class="c1"># Geo-targeting</span>
</span><span data-line="19">    <span class="n">preferred_countries</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;US&quot;</span><span class="p">,</span> <span class="s2">&quot;GB&quot;</span><span class="p">],</span>
</span><span data-line="20">    <span class="n">preferred_regions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;California&quot;</span><span class="p">,</span> <span class="s2">&quot;London&quot;</span><span class="p">],</span>
</span><span data-line="21">    <span class="n">geo_fallback_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="22">    <span class="n">geo_secondary_strategy</span><span class="o">=</span><span class="s2">&quot;round_robin&quot;</span><span class="p">,</span>
</span><span data-line="23">
</span><span data-line="24">    <span class="c1"># Fallback behavior</span>
</span><span data-line="25">    <span class="n">fallback_strategy</span><span class="o">=</span><span class="s2">&quot;random&quot;</span><span class="p">,</span>
</span><span data-line="26">
</span><span data-line="27">    <span class="c1"># Performance thresholds</span>
</span><span data-line="28">    <span class="n">max_response_time_ms</span><span class="o">=</span><span class="mf">5000.0</span><span class="p">,</span>
</span><span data-line="29">    <span class="n">min_success_rate</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
</span><span data-line="30">
</span><span data-line="31">    <span class="c1"># Sliding window</span>
</span><span data-line="32">    <span class="n">window_duration_seconds</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>  <span class="c1"># 1 hour</span>
</span><span data-line="33"><span class="p">)</span>
</span><span data-line="34">
</span><span data-line="35"><span class="c1"># Apply to strategy</span>
</span><span data-line="36"><span class="n">strategy</span> <span class="o">=</span> <span class="n">PerformanceBasedStrategy</span><span class="p">()</span>
</span><span data-line="37"><span class="n">strategy</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="per-strategy-configuration">
<h3><a class="toc-backref" href="#id74" role="doc-backlink">Per-Strategy Configuration</a><a class="headerlink" href="#per-strategy-configuration" title="Link to this heading">¶</a></h3>
<p>Different strategies use different fields:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl</span><span class="w"> </span><span class="kn">import</span> <span class="n">StrategyConfig</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.strategies</span><span class="w"> </span><span class="kn">import</span> <span class="n">PerformanceBasedStrategy</span><span class="p">,</span> <span class="n">SessionPersistenceStrategy</span><span class="p">,</span> <span class="n">GeoTargetedStrategy</span>
</span><span data-line="3">
</span><span data-line="4"><span class="c1"># Performance-based: uses ema_alpha</span>
</span><span data-line="5"><span class="n">perf_config</span> <span class="o">=</span> <span class="n">StrategyConfig</span><span class="p">(</span><span class="n">ema_alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span data-line="6"><span class="n">perf_strategy</span> <span class="o">=</span> <span class="n">PerformanceBasedStrategy</span><span class="p">()</span>
</span><span data-line="7"><span class="n">perf_strategy</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">perf_config</span><span class="p">)</span>
</span><span data-line="8">
</span><span data-line="9"><span class="c1"># Session persistence: uses session_stickiness_duration_seconds</span>
</span><span data-line="10"><span class="n">session_config</span> <span class="o">=</span> <span class="n">StrategyConfig</span><span class="p">(</span><span class="n">session_stickiness_duration_seconds</span><span class="o">=</span><span class="mi">1800</span><span class="p">)</span>
</span><span data-line="11"><span class="n">session_strategy</span> <span class="o">=</span> <span class="n">SessionPersistenceStrategy</span><span class="p">()</span>
</span><span data-line="12"><span class="n">session_strategy</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">session_config</span><span class="p">)</span>
</span><span data-line="13">
</span><span data-line="14"><span class="c1"># Geo-targeted: uses geo_* fields</span>
</span><span data-line="15"><span class="n">geo_config</span> <span class="o">=</span> <span class="n">StrategyConfig</span><span class="p">(</span>
</span><span data-line="16">    <span class="n">geo_fallback_enabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="17">    <span class="n">geo_secondary_strategy</span><span class="o">=</span><span class="s2">&quot;least_used&quot;</span><span class="p">,</span>
</span><span data-line="18"><span class="p">)</span>
</span><span data-line="19"><span class="n">geo_strategy</span> <span class="o">=</span> <span class="n">GeoTargetedStrategy</span><span class="p">()</span>
</span><span data-line="20"><span class="n">geo_strategy</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">geo_config</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
</section>
<section id="custom-strategy-implementation">
<h2><a class="toc-backref" href="#id75" role="doc-backlink">Custom Strategy Implementation</a><a class="headerlink" href="#custom-strategy-implementation" title="Link to this heading">¶</a></h2>
<p>Create custom strategies by implementing the <code class="docutils literal notranslate"><span class="pre">RotationStrategy</span></code> protocol. For the full API surface, see <a class="reference internal" href="../reference/python-api.html"><span class="doc">Python API Reference</span></a>.</p>
<section id="implementing-the-protocol">
<h3><a class="toc-backref" href="#id76" role="doc-backlink">Implementing the Protocol</a><a class="headerlink" href="#implementing-the-protocol" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl</span><span class="w"> </span><span class="kn">import</span> <span class="n">Proxy</span><span class="p">,</span> <span class="n">ProxyPool</span><span class="p">,</span> <span class="n">SelectionContext</span>
</span><span data-line="3"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProxyPoolEmptyError</span>
</span><span data-line="4">
</span><span data-line="5"><span class="k">class</span><span class="w"> </span><span class="nc">PriorityStrategy</span><span class="p">:</span>
</span><span data-line="6"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Select proxies based on custom priority field.&quot;&quot;&quot;</span>
</span><span data-line="7">
</span><span data-line="8">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="9">        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="10">
</span><span data-line="11">    <span class="k">def</span><span class="w"> </span><span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">:</span> <span class="n">ProxyPool</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SelectionContext</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Proxy</span><span class="p">:</span>
</span><span data-line="12"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Select highest priority healthy proxy.&quot;&quot;&quot;</span>
</span><span data-line="13">        <span class="n">healthy_proxies</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">get_healthy_proxies</span><span class="p">()</span>
</span><span data-line="14">
</span><span data-line="15">        <span class="k">if</span> <span class="ow">not</span> <span class="n">healthy_proxies</span><span class="p">:</span>
</span><span data-line="16">            <span class="k">raise</span> <span class="n">ProxyPoolEmptyError</span><span class="p">(</span><span class="s2">&quot;No healthy proxies available&quot;</span><span class="p">)</span>
</span><span data-line="17">
</span><span data-line="18">        <span class="c1"># Filter by failed proxies from context</span>
</span><span data-line="19">        <span class="k">if</span> <span class="n">context</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">failed_proxy_ids</span><span class="p">:</span>
</span><span data-line="20">            <span class="n">failed_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">failed_proxy_ids</span><span class="p">)</span>
</span><span data-line="21">            <span class="n">healthy_proxies</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">healthy_proxies</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">failed_ids</span><span class="p">]</span>
</span><span data-line="22">
</span><span data-line="23">            <span class="k">if</span> <span class="ow">not</span> <span class="n">healthy_proxies</span><span class="p">:</span>
</span><span data-line="24">                <span class="k">raise</span> <span class="n">ProxyPoolEmptyError</span><span class="p">(</span><span class="s2">&quot;No healthy proxies after filtering&quot;</span><span class="p">)</span>
</span><span data-line="25">
</span><span data-line="26">        <span class="c1"># Select proxy with highest priority (from metadata)</span>
</span><span data-line="27">        <span class="n">proxy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">healthy_proxies</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;priority&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span data-line="28">
</span><span data-line="29">        <span class="c1"># Mark request start</span>
</span><span data-line="30">        <span class="n">proxy</span><span class="o">.</span><span class="n">start_request</span><span class="p">()</span>
</span><span data-line="31">
</span><span data-line="32">        <span class="k">return</span> <span class="n">proxy</span>
</span><span data-line="33">
</span><span data-line="34">    <span class="k">def</span><span class="w"> </span><span class="nf">record_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">:</span> <span class="n">Proxy</span><span class="p">,</span> <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">response_time_ms</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="35"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record request result.&quot;&quot;&quot;</span>
</span><span data-line="36">        <span class="n">proxy</span><span class="o">.</span><span class="n">complete_request</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="n">success</span><span class="p">,</span> <span class="n">response_time_ms</span><span class="o">=</span><span class="n">response_time_ms</span><span class="p">)</span>
</span><span data-line="37">
</span><span data-line="38">    <span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
</span><span data-line="39"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Optional: accept configuration.&quot;&quot;&quot;</span>
</span><span data-line="40">        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
</span></pre></div>
</div>
</section>
<section id="registering-custom-strategies">
<h3><a class="toc-backref" href="#id77" role="doc-backlink">Registering Custom Strategies</a><a class="headerlink" href="#registering-custom-strategies" title="Link to this heading">¶</a></h3>
<p>Use <code class="docutils literal notranslate"><span class="pre">StrategyRegistry</span></code> to register and reuse custom strategies. Registered strategies are also available through the <a class="reference internal" href="cli-reference.html"><span class="doc">CLI Reference</span></a> (<code class="docutils literal notranslate"><span class="pre">proxywhirl</span> <span class="pre">config</span> <span class="pre">set</span> <span class="pre">rotation_strategy</span> <span class="pre">...</span></code>) and the <a class="reference internal" href="mcp-server.html"><span class="doc">MCP Server Guide</span></a> (<code class="docutils literal notranslate"><span class="pre">set_strategy</span></code> action).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncProxyRotator</span><span class="p">,</span> <span class="n">Proxy</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.strategies</span><span class="w"> </span><span class="kn">import</span> <span class="n">StrategyRegistry</span>
</span><span data-line="3">
</span><span data-line="4"><span class="c1"># Register the strategy</span>
</span><span data-line="5"><span class="n">registry</span> <span class="o">=</span> <span class="n">StrategyRegistry</span><span class="p">()</span>
</span><span data-line="6"><span class="n">registry</span><span class="o">.</span><span class="n">register_strategy</span><span class="p">(</span><span class="s2">&quot;priority&quot;</span><span class="p">,</span> <span class="n">PriorityStrategy</span><span class="p">)</span>
</span><span data-line="7">
</span><span data-line="8"><span class="c1"># Use the custom strategy instance</span>
</span><span data-line="9"><span class="n">strategy</span> <span class="o">=</span> <span class="n">PriorityStrategy</span><span class="p">()</span>
</span><span data-line="10">
</span><span data-line="11"><span class="k">async</span> <span class="k">with</span> <span class="n">AsyncProxyRotator</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">)</span> <span class="k">as</span> <span class="n">rotator</span><span class="p">:</span>
</span><span data-line="12">    <span class="c1"># Add proxies with priority metadata</span>
</span><span data-line="13">    <span class="k">await</span> <span class="n">rotator</span><span class="o">.</span><span class="n">add_proxy</span><span class="p">(</span><span class="n">Proxy</span><span class="p">(</span>
</span><span data-line="14">        <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://proxy1.com:8080&quot;</span><span class="p">,</span>
</span><span data-line="15">        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
</span><span data-line="16">    <span class="p">))</span>
</span><span data-line="17">    <span class="k">await</span> <span class="n">rotator</span><span class="o">.</span><span class="n">add_proxy</span><span class="p">(</span><span class="n">Proxy</span><span class="p">(</span>
</span><span data-line="18">        <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://proxy2.com:8080&quot;</span><span class="p">,</span>
</span><span data-line="19">        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
</span><span data-line="20">    <span class="p">))</span>
</span><span data-line="21">
</span><span data-line="22">    <span class="c1"># Selects proxy1 (higher priority)</span>
</span><span data-line="23">    <span class="n">proxy</span> <span class="o">=</span> <span class="k">await</span> <span class="n">rotator</span><span class="o">.</span><span class="n">get_proxy</span><span class="p">()</span>
</span></pre></div>
</div>
</section>
</section>
<section id="strategyregistry-usage">
<h2><a class="toc-backref" href="#id78" role="doc-backlink">StrategyRegistry Usage</a><a class="headerlink" href="#strategyregistry-usage" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">StrategyRegistry</span></code> provides a singleton registry for custom rotation strategies.</p>
<section id="registration-and-validation">
<h3><a class="toc-backref" href="#id79" role="doc-backlink">Registration and Validation</a><a class="headerlink" href="#registration-and-validation" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.strategies</span><span class="w"> </span><span class="kn">import</span> <span class="n">StrategyRegistry</span>
</span><span data-line="2">
</span><span data-line="3"><span class="c1"># Get singleton instance</span>
</span><span data-line="4"><span class="n">registry</span> <span class="o">=</span> <span class="n">StrategyRegistry</span><span class="p">()</span>
</span><span data-line="5">
</span><span data-line="6"><span class="c1"># Register strategy with validation</span>
</span><span data-line="7"><span class="n">registry</span><span class="o">.</span><span class="n">register_strategy</span><span class="p">(</span><span class="s2">&quot;custom&quot;</span><span class="p">,</span> <span class="n">CustomStrategy</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="8">
</span><span data-line="9"><span class="c1"># List all strategies</span>
</span><span data-line="10"><span class="n">strategies</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">list_strategies</span><span class="p">()</span>
</span><span data-line="11"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Available: </span><span class="si">{</span><span class="n">strategies</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="12">
</span><span data-line="13"><span class="c1"># Retrieve strategy class</span>
</span><span data-line="14"><span class="n">strategy_class</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">get_strategy</span><span class="p">(</span><span class="s2">&quot;custom&quot;</span><span class="p">)</span>
</span><span data-line="15"><span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy_class</span><span class="p">()</span>
</span></pre></div>
</div>
</section>
<section id="strategy-validation">
<h3><a class="toc-backref" href="#id80" role="doc-backlink">Strategy Validation</a><a class="headerlink" href="#strategy-validation" title="Link to this heading">¶</a></h3>
<p>The registry validates strategies on registration:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="k">class</span><span class="w"> </span><span class="nc">InvalidStrategy</span><span class="p">:</span>
</span><span data-line="2"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Missing required methods.&quot;&quot;&quot;</span>
</span><span data-line="3">    <span class="k">def</span><span class="w"> </span><span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">):</span>
</span><span data-line="4">        <span class="k">return</span> <span class="n">pool</span><span class="o">.</span><span class="n">get_all_proxies</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="5">    <span class="c1"># Missing record_result() method!</span>
</span><span data-line="6">
</span><span data-line="7"><span class="n">registry</span> <span class="o">=</span> <span class="n">StrategyRegistry</span><span class="p">()</span>
</span><span data-line="8">
</span><span data-line="9"><span class="k">try</span><span class="p">:</span>
</span><span data-line="10">    <span class="n">registry</span><span class="o">.</span><span class="n">register_strategy</span><span class="p">(</span><span class="s2">&quot;invalid&quot;</span><span class="p">,</span> <span class="n">InvalidStrategy</span><span class="p">)</span>
</span><span data-line="11"><span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="12">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="13">    <span class="c1"># Output: Strategy InvalidStrategy missing required methods: record_result</span>
</span></pre></div>
</div>
</section>
<section id="id15">
<h3><a class="toc-backref" href="#id81" role="doc-backlink">Thread Safety</a><a class="headerlink" href="#id15" title="Link to this heading">¶</a></h3>
<p>The registry is thread-safe with double-checked locking:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">import</span><span class="w"> </span><span class="nn">concurrent.futures</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.strategies</span><span class="w"> </span><span class="kn">import</span> <span class="n">StrategyRegistry</span>
</span><span data-line="3">
</span><span data-line="4"><span class="k">def</span><span class="w"> </span><span class="nf">register_strategy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">strategy_class</span><span class="p">):</span>
</span><span data-line="5">    <span class="n">registry</span> <span class="o">=</span> <span class="n">StrategyRegistry</span><span class="p">()</span>
</span><span data-line="6">    <span class="n">registry</span><span class="o">.</span><span class="n">register_strategy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">strategy_class</span><span class="p">)</span>
</span><span data-line="7">
</span><span data-line="8"><span class="c1"># Safe to register from multiple threads</span>
</span><span data-line="9"><span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
</span><span data-line="10">    <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="11">        <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">register_strategy</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;strategy-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">CustomStrategy</span><span class="p">)</span>
</span><span data-line="12">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span data-line="13">    <span class="p">]</span>
</span><span data-line="14">    <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="unregistering-strategies">
<h3><a class="toc-backref" href="#id82" role="doc-backlink">Unregistering Strategies</a><a class="headerlink" href="#unregistering-strategies" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="n">registry</span> <span class="o">=</span> <span class="n">StrategyRegistry</span><span class="p">()</span>
</span><span data-line="2">
</span><span data-line="3"><span class="c1"># Register</span>
</span><span data-line="4"><span class="n">registry</span><span class="o">.</span><span class="n">register_strategy</span><span class="p">(</span><span class="s2">&quot;custom&quot;</span><span class="p">,</span> <span class="n">CustomStrategy</span><span class="p">)</span>
</span><span data-line="5">
</span><span data-line="6"><span class="c1"># Unregister</span>
</span><span data-line="7"><span class="n">registry</span><span class="o">.</span><span class="n">unregister_strategy</span><span class="p">(</span><span class="s2">&quot;custom&quot;</span><span class="p">)</span>
</span><span data-line="8">
</span><span data-line="9"><span class="c1"># Verify removal</span>
</span><span data-line="10"><span class="k">try</span><span class="p">:</span>
</span><span data-line="11">    <span class="n">registry</span><span class="o">.</span><span class="n">get_strategy</span><span class="p">(</span><span class="s2">&quot;custom&quot;</span><span class="p">)</span>
</span><span data-line="12"><span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="13">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Strategy removed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="testing-with-registry-reset">
<h3><a class="toc-backref" href="#id83" role="doc-backlink">Testing with Registry Reset</a><a class="headerlink" href="#testing-with-registry-reset" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.strategies</span><span class="w"> </span><span class="kn">import</span> <span class="n">StrategyRegistry</span>
</span><span data-line="2">
</span><span data-line="3"><span class="k">def</span><span class="w"> </span><span class="nf">test_custom_strategy</span><span class="p">():</span>
</span><span data-line="4">    <span class="c1"># Reset to clean state</span>
</span><span data-line="5">    <span class="n">StrategyRegistry</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</span><span data-line="6">
</span><span data-line="7">    <span class="n">registry</span> <span class="o">=</span> <span class="n">StrategyRegistry</span><span class="p">()</span>
</span><span data-line="8">    <span class="n">registry</span><span class="o">.</span><span class="n">register_strategy</span><span class="p">(</span><span class="s2">&quot;test-strategy&quot;</span><span class="p">,</span> <span class="n">TestStrategy</span><span class="p">)</span>
</span><span data-line="9">
</span><span data-line="10">    <span class="c1"># Test the strategy</span>
</span><span data-line="11">    <span class="c1"># ...</span>
</span><span data-line="12">
</span><span data-line="13">    <span class="c1"># Cleanup</span>
</span><span data-line="14">    <span class="n">StrategyRegistry</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</span></pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code class="docutils literal notranslate"><span class="pre">StrategyRegistry.reset()</span></code> should only be used in tests. Calling it in production will clear all registered strategies.</p>
</div>
</section>
<section id="performance-requirements">
<h3><a class="toc-backref" href="#id84" role="doc-backlink">Performance Requirements</a><a class="headerlink" href="#performance-requirements" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>SC-010</strong>: Strategy registration &lt;1 second load time</p></li>
<li><p><strong>Validation</strong>: &lt;1ms per strategy</p></li>
<li><p><strong>Retrieval</strong>: O(1) lookup</p></li>
</ul>
</section>
</section>
<section id="id16">
<h2><a class="toc-backref" href="#id85" role="doc-backlink">Best Practices</a><a class="headerlink" href="#id16" title="Link to this heading">¶</a></h2>
<section id="choose-the-right-strategy">
<h3><a class="toc-backref" href="#id86" role="doc-backlink">1. Choose the Right Strategy</a><a class="headerlink" href="#choose-the-right-strategy" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Stateful scraping? Use session persistence</span>
</span><span data-line="2"><span class="k">if</span> <span class="n">requires_cookies_or_login</span><span class="p">:</span>
</span><span data-line="3">    <span class="n">strategy</span> <span class="o">=</span> <span class="n">SessionPersistenceStrategy</span><span class="p">()</span>
</span><span data-line="4">
</span><span data-line="5"><span class="c1"># Geo-locked content? Use geo-targeting</span>
</span><span data-line="6"><span class="k">elif</span> <span class="n">requires_specific_region</span><span class="p">:</span>
</span><span data-line="7">    <span class="n">strategy</span> <span class="o">=</span> <span class="n">GeoTargetedStrategy</span><span class="p">()</span>
</span><span data-line="8">
</span><span data-line="9"><span class="c1"># Performance-critical? Use performance-based</span>
</span><span data-line="10"><span class="k">elif</span> <span class="n">latency_sensitive</span><span class="p">:</span>
</span><span data-line="11">    <span class="n">strategy</span> <span class="o">=</span> <span class="n">PerformanceBasedStrategy</span><span class="p">()</span>
</span><span data-line="12">
</span><span data-line="13"><span class="c1"># Complex requirements? Use composite</span>
</span><span data-line="14"><span class="k">else</span><span class="p">:</span>
</span><span data-line="15">    <span class="n">strategy</span> <span class="o">=</span> <span class="n">CompositeStrategy</span><span class="p">(</span>
</span><span data-line="16">        <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="n">GeoTargetedStrategy</span><span class="p">()],</span>
</span><span data-line="17">        <span class="n">selector</span><span class="o">=</span><span class="n">PerformanceBasedStrategy</span><span class="p">(),</span>
</span><span data-line="18">    <span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="warm-up-performance-based-strategies">
<h3><a class="toc-backref" href="#id87" role="doc-backlink">2. Warm Up Performance-Based Strategies</a><a class="headerlink" href="#warm-up-performance-based-strategies" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Don&#39;t use performance-based immediately</span>
</span><span data-line="2"><span class="n">pool</span> <span class="o">=</span> <span class="n">ProxyPool</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;new-pool&quot;</span><span class="p">)</span>
</span><span data-line="3"><span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">fetch_new_proxies</span><span class="p">():</span>
</span><span data-line="4">    <span class="n">pool</span><span class="o">.</span><span class="n">add_proxy</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
</span><span data-line="5">
</span><span data-line="6"><span class="c1"># Warm up with round-robin first</span>
</span><span data-line="7"><span class="n">warmup_strategy</span> <span class="o">=</span> <span class="n">RoundRobinStrategy</span><span class="p">()</span>
</span><span data-line="8"><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">proxies</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">):</span>  <span class="c1"># 5 requests per proxy</span>
</span><span data-line="9">    <span class="n">proxy</span> <span class="o">=</span> <span class="n">warmup_strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>
</span><span data-line="10">    <span class="c1"># Make request and record result</span>
</span><span data-line="11">    <span class="n">warmup_strategy</span><span class="o">.</span><span class="n">record_result</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">response_time_ms</span><span class="o">=</span><span class="mf">100.0</span><span class="p">)</span>
</span><span data-line="12">
</span><span data-line="13"><span class="c1"># Now switch to performance-based</span>
</span><span data-line="14"><span class="n">strategy</span> <span class="o">=</span> <span class="n">PerformanceBasedStrategy</span><span class="p">()</span>
</span></pre></div>
</div>
</section>
<section id="monitor-session-memory">
<h3><a class="toc-backref" href="#id88" role="doc-backlink">3. Monitor Session Memory</a><a class="headerlink" href="#monitor-session-memory" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="n">strategy</span> <span class="o">=</span> <span class="n">SessionPersistenceStrategy</span><span class="p">(</span><span class="n">max_sessions</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</span><span data-line="2">
</span><span data-line="3"><span class="c1"># Periodically check session count</span>
</span><span data-line="4"><span class="n">stats</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">get_session_stats</span><span class="p">()</span>
</span><span data-line="5"><span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_sessions&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">8000</span><span class="p">:</span>  <span class="c1"># 80% capacity</span>
</span><span data-line="6">    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: High session count&quot;</span><span class="p">)</span>
</span><span data-line="7">    <span class="n">strategy</span><span class="o">.</span><span class="n">cleanup_expired_sessions</span><span class="p">()</span>
</span></pre></div>
</div>
</section>
<section id="use-selectioncontext-consistently">
<h3><a class="toc-backref" href="#id89" role="doc-backlink">4. Use SelectionContext Consistently</a><a class="headerlink" href="#use-selectioncontext-consistently" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Build context once per request</span>
</span><span data-line="2"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span>
</span><span data-line="3">    <span class="n">session_id</span><span class="o">=</span><span class="n">user_session_id</span><span class="p">,</span>
</span><span data-line="4">    <span class="n">target_country</span><span class="o">=</span><span class="n">user_country</span><span class="p">,</span>
</span><span data-line="5">    <span class="n">failed_proxy_ids</span><span class="o">=</span><span class="p">[],</span>
</span><span data-line="6"><span class="p">)</span>
</span><span data-line="7">
</span><span data-line="8"><span class="c1"># Reuse for retries</span>
</span><span data-line="9"><span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
</span><span data-line="10">    <span class="k">try</span><span class="p">:</span>
</span><span data-line="11">        <span class="n">proxy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="12">        <span class="n">response</span> <span class="o">=</span> <span class="n">make_request</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
</span><span data-line="13">        <span class="n">strategy</span><span class="o">.</span><span class="n">record_result</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">response_time_ms</span><span class="o">=</span><span class="n">elapsed</span><span class="p">)</span>
</span><span data-line="14">        <span class="k">break</span>
</span><span data-line="15">    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span data-line="16">        <span class="n">strategy</span><span class="o">.</span><span class="n">record_result</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">response_time_ms</span><span class="o">=</span><span class="mf">5000.0</span><span class="p">)</span>
</span><span data-line="17">        <span class="n">context</span><span class="o">.</span><span class="n">failed_proxy_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">proxy</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
</span><span data-line="18">        <span class="n">context</span><span class="o">.</span><span class="n">attempt_number</span> <span class="o">+=</span> <span class="mi">1</span>
</span></pre></div>
</div>
</section>
<section id="validate-geo-data-availability">
<h3><a class="toc-backref" href="#id90" role="doc-backlink">5. Validate Geo Data Availability</a><a class="headerlink" href="#validate-geo-data-availability" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Check if geo data is available before using geo-targeting</span>
</span><span data-line="2"><span class="n">pool</span> <span class="o">=</span> <span class="n">ProxyPool</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;global&quot;</span><span class="p">)</span>
</span><span data-line="3"><span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span><span class="p">:</span>
</span><span data-line="4">    <span class="n">pool</span><span class="o">.</span><span class="n">add_proxy</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
</span><span data-line="5">
</span><span data-line="6"><span class="n">geo_coverage</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">proxies</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">country_code</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">proxies</span><span class="p">)</span>
</span><span data-line="7"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Geo coverage: </span><span class="si">{</span><span class="n">geo_coverage</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="8">
</span><span data-line="9"><span class="k">if</span> <span class="n">geo_coverage</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>  <span class="c1"># At least 50% have geo data</span>
</span><span data-line="10">    <span class="n">strategy</span> <span class="o">=</span> <span class="n">GeoTargetedStrategy</span><span class="p">()</span>
</span><span data-line="11"><span class="k">else</span><span class="p">:</span>
</span><span data-line="12">    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Low geo coverage, using alternative strategy&quot;</span><span class="p">)</span>
</span><span data-line="13">    <span class="n">strategy</span> <span class="o">=</span> <span class="n">PerformanceBasedStrategy</span><span class="p">()</span>
</span></pre></div>
</div>
</section>
</section>
<section id="troubleshooting">
<h2><a class="toc-backref" href="#id91" role="doc-backlink">Troubleshooting</a><a class="headerlink" href="#troubleshooting" title="Link to this heading">¶</a></h2>
<section id="proxypoolemptyerror-no-proxies-with-ema-data">
<h3><a class="toc-backref" href="#id92" role="doc-backlink">ProxyPoolEmptyError: No proxies with EMA data</a><a class="headerlink" href="#proxypoolemptyerror-no-proxies-with-ema-data" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Problem: Using PerformanceBasedStrategy on new proxies</span>
</span><span data-line="2"><span class="n">strategy</span> <span class="o">=</span> <span class="n">PerformanceBasedStrategy</span><span class="p">()</span>
</span><span data-line="3"><span class="n">proxy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>  <span class="c1"># Error!</span>
</span><span data-line="4">
</span><span data-line="5"><span class="c1"># Solution: Warm up proxies first</span>
</span><span data-line="6"><span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">get_all_proxies</span><span class="p">():</span>
</span><span data-line="7">    <span class="n">proxy</span><span class="o">.</span><span class="n">start_request</span><span class="p">()</span>
</span><span data-line="8">    <span class="n">proxy</span><span class="o">.</span><span class="n">complete_request</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">response_time_ms</span><span class="o">=</span><span class="mf">100.0</span><span class="p">)</span>
</span><span data-line="9">
</span><span data-line="10"><span class="c1"># Now it works</span>
</span><span data-line="11"><span class="n">proxy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="sessionpersistencestrategy-requires-selectioncontext-with-session-id">
<h3><a class="toc-backref" href="#id93" role="doc-backlink">SessionPersistenceStrategy requires SelectionContext with session_id</a><a class="headerlink" href="#sessionpersistencestrategy-requires-selectioncontext-with-session-id" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Problem: Missing session_id</span>
</span><span data-line="2"><span class="n">proxy</span> <span class="o">=</span> <span class="n">session_strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>  <span class="c1"># Error!</span>
</span><span data-line="3">
</span><span data-line="4"><span class="c1"># Solution: Always provide session_id</span>
</span><span data-line="5"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="s2">&quot;user-session-123&quot;</span><span class="p">)</span>
</span><span data-line="6"><span class="n">proxy</span> <span class="o">=</span> <span class="n">session_strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="geo-targeting-returns-unexpected-proxies">
<h3><a class="toc-backref" href="#id94" role="doc-backlink">Geo-targeting returns unexpected proxies</a><a class="headerlink" href="#geo-targeting-returns-unexpected-proxies" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Problem: Fallback enabled, returns any proxy when no match</span>
</span><span data-line="2"><span class="n">config</span> <span class="o">=</span> <span class="n">StrategyConfig</span><span class="p">(</span><span class="n">geo_fallback_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="3"><span class="n">strategy</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span data-line="4">
</span><span data-line="5"><span class="n">context</span> <span class="o">=</span> <span class="n">SelectionContext</span><span class="p">(</span><span class="n">target_country</span><span class="o">=</span><span class="s2">&quot;ZZ&quot;</span><span class="p">)</span>  <span class="c1"># Invalid country</span>
</span><span data-line="6"><span class="n">proxy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>  <span class="c1"># Returns any proxy</span>
</span><span data-line="7">
</span><span data-line="8"><span class="c1"># Solution: Disable fallback for strict filtering</span>
</span><span data-line="9"><span class="n">config</span> <span class="o">=</span> <span class="n">StrategyConfig</span><span class="p">(</span><span class="n">geo_fallback_enabled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span data-line="10"><span class="n">strategy</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span data-line="11">
</span><span data-line="12"><span class="k">try</span><span class="p">:</span>
</span><span data-line="13">    <span class="n">proxy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="14"><span class="k">except</span> <span class="n">ProxyPoolEmptyError</span><span class="p">:</span>
</span><span data-line="15">    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No proxies for target country&quot;</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="composite-strategy-too-slow">
<h3><a class="toc-backref" href="#id95" role="doc-backlink">Composite strategy too slow</a><a class="headerlink" href="#composite-strategy-too-slow" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Problem: Too many filters or large pool</span>
</span><span data-line="2"><span class="n">strategy</span> <span class="o">=</span> <span class="n">CompositeStrategy</span><span class="p">(</span>
</span><span data-line="3">    <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="n">Filter1</span><span class="p">(),</span> <span class="n">Filter2</span><span class="p">(),</span> <span class="n">Filter3</span><span class="p">()],</span>
</span><span data-line="4">    <span class="n">selector</span><span class="o">=</span><span class="n">PerformanceBasedStrategy</span><span class="p">(),</span>
</span><span data-line="5"><span class="p">)</span>
</span><span data-line="6">
</span><span data-line="7"><span class="c1"># Solution: Reduce filter count or optimize filters</span>
</span><span data-line="8"><span class="n">strategy</span> <span class="o">=</span> <span class="n">CompositeStrategy</span><span class="p">(</span>
</span><span data-line="9">    <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="n">GeoTargetedStrategy</span><span class="p">()],</span>  <span class="c1"># Single filter</span>
</span><span data-line="10">    <span class="n">selector</span><span class="o">=</span><span class="n">PerformanceBasedStrategy</span><span class="p">(),</span>
</span><span data-line="11"><span class="p">)</span>
</span><span data-line="12">
</span><span data-line="13"><span class="c1"># Or: Pre-filter pool outside strategy</span>
</span><span data-line="14"><span class="n">us_proxies</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">proxies</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">country_code</span> <span class="o">==</span> <span class="s2">&quot;US&quot;</span><span class="p">]</span>
</span><span data-line="15"><span class="n">filtered_pool</span> <span class="o">=</span> <span class="n">ProxyPool</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;us-only&quot;</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">us_proxies</span><span class="p">)</span>
</span><span data-line="16"><span class="n">strategy</span> <span class="o">=</span> <span class="n">PerformanceBasedStrategy</span><span class="p">()</span>
</span><span data-line="17"><span class="n">proxy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">filtered_pool</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
</section>
<section id="testing-strategies">
<h2><a class="toc-backref" href="#id96" role="doc-backlink">Testing Strategies</a><a class="headerlink" href="#testing-strategies" title="Link to this heading">¶</a></h2>
<p>All strategies have comprehensive integration tests in <code class="docutils literal notranslate"><span class="pre">tests/integration/test_rotation_strategies.py</span></code>. Use these as examples:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProxyPool</span><span class="p">,</span> <span class="n">Proxy</span><span class="p">,</span> <span class="n">HealthStatus</span><span class="p">,</span> <span class="n">SelectionContext</span>
</span><span data-line="3"><span class="kn">from</span><span class="w"> </span><span class="nn">proxywhirl.strategies</span><span class="w"> </span><span class="kn">import</span> <span class="n">PerformanceBasedStrategy</span>
</span><span data-line="4">
</span><span data-line="5"><span class="k">def</span><span class="w"> </span><span class="nf">test_my_use_case</span><span class="p">():</span>
</span><span data-line="6"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test performance-based strategy with my specific scenario.&quot;&quot;&quot;</span>
</span><span data-line="7">    <span class="c1"># Arrange</span>
</span><span data-line="8">    <span class="n">pool</span> <span class="o">=</span> <span class="n">ProxyPool</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;test-pool&quot;</span><span class="p">)</span>
</span><span data-line="9">
</span><span data-line="10">    <span class="c1"># Create proxies matching your scenario</span>
</span><span data-line="11">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
</span><span data-line="12">        <span class="n">proxy</span> <span class="o">=</span> <span class="n">Proxy</span><span class="p">(</span>
</span><span data-line="13">            <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;http://proxy</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.example.com:8080&quot;</span><span class="p">,</span>
</span><span data-line="14">            <span class="n">health_status</span><span class="o">=</span><span class="n">HealthStatus</span><span class="o">.</span><span class="n">HEALTHY</span><span class="p">,</span>
</span><span data-line="15">        <span class="p">)</span>
</span><span data-line="16">        <span class="c1"># Warm up</span>
</span><span data-line="17">        <span class="n">proxy</span><span class="o">.</span><span class="n">start_request</span><span class="p">()</span>
</span><span data-line="18">        <span class="n">proxy</span><span class="o">.</span><span class="n">complete_request</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">response_time_ms</span><span class="o">=</span><span class="mf">100.0</span><span class="p">)</span>
</span><span data-line="19">        <span class="n">pool</span><span class="o">.</span><span class="n">add_proxy</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
</span><span data-line="20">
</span><span data-line="21">    <span class="n">strategy</span> <span class="o">=</span> <span class="n">PerformanceBasedStrategy</span><span class="p">()</span>
</span><span data-line="22">
</span><span data-line="23">    <span class="c1"># Act</span>
</span><span data-line="24">    <span class="n">proxy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>
</span><span data-line="25">
</span><span data-line="26">    <span class="c1"># Assert</span>
</span><span data-line="27">    <span class="k">assert</span> <span class="n">proxy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="28">    <span class="k">assert</span> <span class="n">proxy</span><span class="o">.</span><span class="n">ema_response_time_ms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></pre></div>
</div>
</section>
<section id="performance-benchmarks">
<h2><a class="toc-backref" href="#id97" role="doc-backlink">Performance Benchmarks</a><a class="headerlink" href="#performance-benchmarks" title="Link to this heading">¶</a></h2>
<section id="selection-time">
<h3><a class="toc-backref" href="#id98" role="doc-backlink">Selection Time</a><a class="headerlink" href="#selection-time" title="Link to this heading">¶</a></h3>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Strategy</p></th>
<th class="head"><p>Time (ms)</p></th>
<th class="head"><p>Complexity</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Round-robin</p></td>
<td><p>&lt;0.1</p></td>
<td><p>O(1)</p></td>
<td><p>Index increment</p></td>
</tr>
<tr class="row-odd"><td><p>Random</p></td>
<td><p>&lt;0.1</p></td>
<td><p>O(1)</p></td>
<td><p>Random choice</p></td>
</tr>
<tr class="row-even"><td><p>Weighted</p></td>
<td><p>&lt;0.5</p></td>
<td><p>O(n)</p></td>
<td><p>Weight calculation (cached)</p></td>
</tr>
<tr class="row-odd"><td><p>Least-used</p></td>
<td><p>&lt;0.3</p></td>
<td><p>O(n)</p></td>
<td><p>Min search</p></td>
</tr>
<tr class="row-even"><td><p>Performance-based</p></td>
<td><p>&lt;1.0</p></td>
<td><p>O(n)</p></td>
<td><p>Exploration + weighted choice</p></td>
</tr>
<tr class="row-odd"><td><p>Session</p></td>
<td><p>&lt;1.0</p></td>
<td><p>O(1)</p></td>
<td><p>Session lookup + fallback</p></td>
</tr>
<tr class="row-even"><td><p>Geo-targeted</p></td>
<td><p>&lt;2.0</p></td>
<td><p>O(n)</p></td>
<td><p>Filtering + secondary selection</p></td>
</tr>
<tr class="row-odd"><td><p>Cost-aware</p></td>
<td><p>&lt;0.5</p></td>
<td><p>O(n)</p></td>
<td><p>Inverse cost weights</p></td>
</tr>
<tr class="row-even"><td><p>Composite (2 filters)</p></td>
<td><p>&lt;5.0</p></td>
<td><p>O(n)</p></td>
<td><p>Sum of component times</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="memory-usage">
<h3><a class="toc-backref" href="#id99" role="doc-backlink">Memory Usage</a><a class="headerlink" href="#memory-usage" title="Link to this heading">¶</a></h3>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Component</p></th>
<th class="head"><p>Memory per Item</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Strategy instance</p></td>
<td><p>&lt;1 KB</p></td>
</tr>
<tr class="row-odd"><td><p>WeightedStrategy cache</p></td>
<td><p>~100 bytes per proxy</p></td>
</tr>
<tr class="row-even"><td><p>SessionManager</p></td>
<td><p>~200 bytes per session</p></td>
</tr>
<tr class="row-odd"><td><p>PerformanceBasedStrategy</p></td>
<td><p>No additional memory</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="id17">
<h3><a class="toc-backref" href="#id100" role="doc-backlink">Success Criteria</a><a class="headerlink" href="#id17" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>SC-004</strong>: Performance-based - 15-25% response time reduction</p></li>
<li><p><strong>SC-005</strong>: Session persistence - 99.9% same-proxy guarantee</p></li>
<li><p><strong>SC-006</strong>: Geo-targeting - 100% correct region selection</p></li>
<li><p><strong>SC-007</strong>: Composite strategy - &lt;5ms total selection time</p></li>
<li><p><strong>SC-010</strong>: Strategy registration - &lt;1 second load time</p></li>
</ul>
</section>
</section>
<section id="see-also">
<h2><a class="toc-backref" href="#id101" role="doc-backlink">See Also</a><a class="headerlink" href="#see-also" title="Link to this heading">¶</a></h2>
<div class="sd-container-fluid sd-sphinx-override sd-mb-4 docutils">
<div class="sd-row sd-row-cols-2 sd-row-cols-xs-2 sd-row-cols-sm-2 sd-row-cols-md-2 sd-row-cols-lg-2 sd-g-3 sd-g-xs-3 sd-g-sm-3 sd-g-md-3 sd-g-lg-3 docutils">
<div class="sd-col sd-d-flex-row docutils">
<div class="sd-card sd-sphinx-override sd-w-100 sd-shadow-sm sd-card-hover docutils">
<div class="sd-card-body docutils">
<div class="sd-card-title sd-font-weight-bold docutils">
Async Client Guide</div>
<p class="sd-card-text">Using <code class="docutils literal notranslate"><span class="pre">AsyncProxyRotator</span></code> with all strategies, concurrency patterns, and integration with FastAPI/aiohttp.</p>
</div>
<a class="sd-stretched-link sd-hide-link-text reference internal" href="async-client.html"><span class="doc">Async Client Guide</span></a></div>
</div>
<div class="sd-col sd-d-flex-row docutils">
<div class="sd-card sd-sphinx-override sd-w-100 sd-shadow-sm sd-card-hover docutils">
<div class="sd-card-body docutils">
<div class="sd-card-title sd-font-weight-bold docutils">
Retry &amp; Failover</div>
<p class="sd-card-text">Circuit breakers, backoff strategies, and intelligent proxy failover that work with all strategies.</p>
</div>
<a class="sd-stretched-link sd-hide-link-text reference internal" href="retry-failover.html"><span class="doc">Retry &amp; Failover Guide</span></a></div>
</div>
<div class="sd-col sd-d-flex-row docutils">
<div class="sd-card sd-sphinx-override sd-w-100 sd-shadow-sm sd-card-hover docutils">
<div class="sd-card-body docutils">
<div class="sd-card-title sd-font-weight-bold docutils">
Caching Subsystem</div>
<p class="sd-card-text">Three-tier caching for proxy persistence and credential encryption.</p>
</div>
<a class="sd-stretched-link sd-hide-link-text reference internal" href="caching.html"><span class="doc">Caching Subsystem Guide</span></a></div>
</div>
<div class="sd-col sd-d-flex-row docutils">
<div class="sd-card sd-sphinx-override sd-w-100 sd-shadow-sm sd-card-hover docutils">
<div class="sd-card-body docutils">
<div class="sd-card-title sd-font-weight-bold docutils">
Python API Reference</div>
<p class="sd-card-text">Complete API docs for <code class="docutils literal notranslate"><span class="pre">RotationStrategy</span></code>, <code class="docutils literal notranslate"><span class="pre">StrategyRegistry</span></code>, <code class="docutils literal notranslate"><span class="pre">SelectionContext</span></code>, and all strategy classes.</p>
</div>
<a class="sd-stretched-link sd-hide-link-text reference internal" href="../reference/python-api.html"><span class="doc">Python API Reference</span></a></div>
</div>
<div class="sd-col sd-d-flex-row docutils">
<div class="sd-card sd-sphinx-override sd-w-100 sd-shadow-sm sd-card-hover docutils">
<div class="sd-card-body docutils">
<div class="sd-card-title sd-font-weight-bold docutils">
Rotation Strategies Overview</div>
<p class="sd-card-text">Introduction to basic rotation strategies and getting started with proxy selection.</p>
</div>
<a class="sd-stretched-link sd-hide-link-text reference internal" href="../getting-started/rotation-strategies.html"><span class="doc">Rotation Strategies</span></a></div>
</div>
<div class="sd-col sd-d-flex-row docutils">
<div class="sd-card sd-sphinx-override sd-w-100 sd-shadow-sm sd-card-hover docutils">
<div class="sd-card-body docutils">
<div class="sd-card-title sd-font-weight-bold docutils">
CLI Reference</div>
<p class="sd-card-text">Set strategies and monitor proxy health from the command line.</p>
</div>
<a class="sd-stretched-link sd-hide-link-text reference internal" href="cli-reference.html"><span class="doc">CLI Reference</span></a></div>
</div>
</div>
</div>
<p><strong>Additional Resources:</strong></p>
<ul class="simple">
<li><p><strong>Integration Tests:</strong> <code class="docutils literal notranslate"><span class="pre">tests/integration/test_rotation_strategies.py</span></code></p></li>
<li><p><strong>Specs:</strong> <code class="docutils literal notranslate"><span class="pre">.specify/specs/014-retry-failover-logic/</span></code></p></li>
</ul>
</section>
</section>

        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"><div class="navigation-prev">
    <a href="async-client.html">
      <i class="i-lucide chevron-left"></i>
      <div class="page-info">
        <span>Previous</span><div class="title">Async Client Guide</div></div>
    </a>
  </div><div class="navigation-next">
    <a href="caching.html">
      <div class="page-info">
        <span>Next</span>
        <div class="title">Caching Subsystem Guide</div>
      </div>
      <i class="i-lucide chevron-right"></i>
    </a>
  </div></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2026, Wyatt Walsh</p>
  
  <p>
    Made with
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials">
<a href="https://github.com/wyattowalsh/proxywhirl" aria-label="GitHub">
  <iconify-icon icon="simple-icons:github"></iconify-icon>
</a></div>
    </div>
  </div>
</footer>
      <script src="../_static/documentation_options.js?v=360bc84d"></script>
      <script src="../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
      <script src="../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../_static/shibuya.js?v=cac61aee"></script>
      <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
      <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.esm.min.mjs";





const initStyles = () => {
    const defaultStyle = document.createElement('style');
    defaultStyle.textContent = `pre.mermaid {
    /* Same as .mermaid-container > pre */
    display: block;
    width: 100%;
}

pre.mermaid > svg {
    /* Same as .mermaid-container > pre > svg */
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}`;
    document.head.appendChild(defaultStyle);

    const fullscreenStyle = document.createElement('style');
    fullscreenStyle.textContent = `.mermaid-container {
    display: flex;
    flex-direction: row;
    width: 100%;
}

.mermaid-container > pre {
    display: block;
    width: 100%;
}

.mermaid-container > pre > svg {
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}

.mermaid-fullscreen-btn {
    width: 28px;
    height: 28px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    font-size: 14px;
    line-height: 1;
    padding: 0;
    color: #333;
}

.mermaid-fullscreen-btn:hover {
    opacity: 100% !important;
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    transform: scale(1.1);
}

.mermaid-fullscreen-btn.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #e0e0e0;
}

.mermaid-fullscreen-btn.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 3px 10px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal {
    display: none;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 95vw;
    height: 100vh;
    background: rgba(255, 255, 255, 0.98);
    z-index: 9999;
    padding: 20px;
    overflow: auto;
}

.mermaid-fullscreen-modal.dark-theme {
    background: rgba(0, 0, 0, 0.98);
}

.mermaid-fullscreen-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen {
    position: relative;
    width: 95vw;
    height: 90vh;
    max-width: 95vw;
    max-height: 90vh;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen.dark-theme {
    background: #1a1a1a;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
}

.mermaid-container-fullscreen pre.mermaid {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen .mermaid svg {
    height: 100% !important;
    width: 100% !important;
    cursor: grab;
}

.mermaid-fullscreen-close {
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 50%;
    cursor: pointer;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: all 0.2s;
    font-size: 24px;
    line-height: 1;
    color: #333;
}

.mermaid-fullscreen-close:hover {
    background: white;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    transform: scale(1.1);
}

.mermaid-fullscreen-close.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #e0e0e0;
}

.mermaid-fullscreen-close.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 6px 16px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal .mermaid-fullscreen-btn {
    display: none !important;
}`;
    document.head.appendChild(fullscreenStyle);
}

// Detect if page has dark background
const isDarkTheme = () => {
    // We use a set of heuristics:
    // 1. Check for common dark mode classes or attributes
    // 2. Check computed background color brightness
    if (document.documentElement.classList.contains('dark') ||
        document.documentElement.getAttribute('data-theme') === 'dark' ||
        document.body.classList.contains('dark') ||
        document.body.getAttribute('data-theme') === 'dark') {
        // console.log("Dark theme detected via class/attribute");
        return true;
    }
    if (document.documentElement.classList.contains('light') ||
        document.documentElement.getAttribute('data-theme') === 'light' ||
        document.body.classList.contains('light') ||
        document.body.getAttribute('data-theme') === 'light') {
        // console.log("Light theme detected via class/attribute");
        return false;
    }
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        // console.log("Dark theme detected via prefers-color-scheme");
        return true;
    }
    const bgColor = window.getComputedStyle(document.body).backgroundColor;
    const match = bgColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)/);
    if (match) {
        const r = parseInt(match[1]);
        const g = parseInt(match[2]);
        const b = parseInt(match[3]);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        // console.log("Background color brightness:", brightness);
        return brightness < 128;
    }
    // console.log("No dark or light theme detected, defaulting to light theme");
    return false;
};

let darkTheme = isDarkTheme();
let modal = null;
let modalContent = null;
let previousScrollOffset = [window.scrollX, window.scrollY];

const runMermaid = async (rerun) => {
    console.log("Running mermaid diagrams, rerun =", rerun);
    // clear all existing mermaid charts
    let all_mermaids = document.querySelectorAll(".mermaid");

    if (rerun) {
        all_mermaids.forEach((el) => {
            if(!el.hasAttribute("data-original-code")) {
                // store original code
                // console.log(`Storing original code for first run: `, el.innerHTML);
                el.setAttribute('data-original-code', el.innerHTML);
            }
            if(el.getAttribute("data-processed") === "true") {
                // remove and restore original
                el.removeAttribute("data-processed");
                // console.log(`Restoring original code for re-run: `, el.getAttribute('data-original-code'));
                el.innerHTML = el.getAttribute('data-original-code');
            } else {
                // store original code
                // console.log(`Storing original code for re-run: `, el.innerHTML);
                el.setAttribute('data-original-code', el.innerHTML);
            }
        });
        await mermaid.run();
    }

    all_mermaids = document.querySelectorAll(".mermaid");
    const mermaids_processed = document.querySelectorAll(".mermaid[data-processed='true']");

    if ("False" === "True") {
        const mermaids_to_add_zoom = -1 === -1 ? all_mermaids.length : -1;
        if(mermaids_to_add_zoom > 0) {
            var svgs = d3.selectAll("");
            if(all_mermaids.length !== mermaids_processed.length) {
                setTimeout(() => runMermaid(false), 200);
                return;
            } else if(svgs.size() !== mermaids_to_add_zoom) {
                setTimeout(() => runMermaid(false), 200);
                return;
            } else {
                svgs.each(function() {
                    var svg = d3.select(this);
                    svg.html("<g class='wrapper'>" + svg.html() + "</g>");
                    var inner = svg.select("g");
                    var zoom = d3.zoom().on("zoom", function(event) {
                        inner.attr("transform", event.transform);
                    });
                    svg.call(zoom);
                });
            }
        }
    } else if(all_mermaids.length !== mermaids_processed.length) {
        // Wait for mermaid to process all diagrams
        setTimeout(() => runMermaid(false), 200);
        return;
    }

    // Stop here if not adding fullscreen capability
    if ("True" !== "True") return;

    if (modal !== null ) {
        // Destroy existing modal
        modal.remove();
        modal = null;
        modalContent = null;
    }

    modal = document.createElement('div');
    modal.className = 'mermaid-fullscreen-modal' + (darkTheme ? ' dark-theme' : '');
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    modal.setAttribute('aria-label', 'Fullscreen diagram viewer');
    modal.innerHTML = `
        <button class="mermaid-fullscreen-close${darkTheme ? ' dark-theme' : ''}" aria-label="Close fullscreen">✕</button>
        <div class="mermaid-container-fullscreen${darkTheme ? ' dark-theme' : ''}"></div>
    `;
    document.body.appendChild(modal);

    modalContent = modal.querySelector('.mermaid-container-fullscreen');
    const closeBtn = modal.querySelector('.mermaid-fullscreen-close');

    const closeModal = () => {
        modal.classList.remove('active');
        modalContent.innerHTML = '';
        document.body.style.overflow = ''
        window.scrollTo({left: previousScrollOffset[0], top: previousScrollOffset[1], behavior: 'instant'});
    };

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
        }
    });

    document.querySelectorAll('.mermaid').forEach((mermaidDiv) => {
        if (mermaidDiv.parentNode.classList.contains('mermaid-container') ||
            mermaidDiv.closest('.mermaid-fullscreen-modal')) {
            // Already processed, adjust button class if needed
            const existingBtn = mermaidDiv.parentNode.querySelector('.mermaid-fullscreen-btn');
            if (existingBtn) {
                existingBtn.className = 'mermaid-fullscreen-btn' + (darkTheme ? ' dark-theme' : '');
            }
            return;
        }

        const container = document.createElement('div');
        container.className = 'mermaid-container';
        mermaidDiv.parentNode.insertBefore(container, mermaidDiv);
        container.appendChild(mermaidDiv);

        const fullscreenBtn = document.createElement('button');
        fullscreenBtn.className = 'mermaid-fullscreen-btn' + (darkTheme ? ' dark-theme' : '');
        fullscreenBtn.setAttribute('aria-label', 'View diagram in fullscreen');
        fullscreenBtn.textContent = '⛶';
        fullscreenBtn.style.opacity = '50%';

        // Calculate dynamic position based on diagram's margin and padding
        const diagramStyle = window.getComputedStyle(mermaidDiv);
        const marginTop = parseFloat(diagramStyle.marginTop) || 0;
        const marginRight = parseFloat(diagramStyle.marginRight) || 0;
        const paddingTop = parseFloat(diagramStyle.paddingTop) || 0;
        const paddingRight = parseFloat(diagramStyle.paddingRight) || 0;
        fullscreenBtn.style.top = `${marginTop + paddingTop + 4}px`;
        fullscreenBtn.style.right = `${marginRight + paddingRight + 4}px`;

        fullscreenBtn.addEventListener('click', () => {
            previousScrollOffset = [window.scroll, window.scrollY];
            const clone = mermaidDiv.cloneNode(true);
            modalContent.innerHTML = '';
            modalContent.appendChild(clone);

            const svg = clone.querySelector('svg');
            if (svg) {
                svg.removeAttribute('width');
                svg.removeAttribute('height');
                svg.style.width = '100%';
                svg.style.height = 'auto';
                svg.style.maxWidth = '100%';
                svg.style.sdisplay = 'block';

                if ("False" === "True") {
                    setTimeout(() => {
                        const g = svg.querySelector('g');
                        if (g) {
                            var svgD3 = d3.select(svg);
                            svgD3.html("<g class='wrapper'>" + svgD3.html() + "</g>");
                            var inner = svgD3.select("g");
                            var zoom = d3.zoom().on("zoom", function(event) {
                                inner.attr("transform", event.transform);
                            });
                            svgD3.call(zoom);
                        }
                    }, 100);
                }
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        });
        container.appendChild(fullscreenBtn);
    });
};

const load = async () => {
    initStyles();

    await runMermaid(true);

    const reRunIfThemeChanges = async () => {
        const newDarkTheme = isDarkTheme();
        if (newDarkTheme !== darkTheme) {
            darkTheme = newDarkTheme;
            console.log("Theme change detected, re-running mermaid with", darkTheme ? "dark" : "default", "theme");
            await mermaid.initialize(
                {...JSON.parse(
                    `{"startOnLoad": false}`
                ),
                ...{ darkMode: darkTheme, theme: darkTheme ? 'dark' : 'default' },
                }
            );
            await runMermaid(true);
        }
    };

    // Update theme classes when theme changes
    const themeObserver = new MutationObserver(reRunIfThemeChanges);
    themeObserver.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class', 'style', 'data-theme']
    });
    themeObserver.observe(document.body, {
        attributes: true,
        attributeFilter: ['class', 'style', 'data-theme']
    });
};





console.log("Initializing mermaid with", darkTheme ? "dark" : "default", "theme");
mermaid.initialize(
    {...JSON.parse(
        `{"startOnLoad": false}`
    ),
    ...{ darkMode: darkTheme, theme: darkTheme ? 'dark' : 'default' },
    }
);

window.addEventListener("load", load);</script></body>
</html>