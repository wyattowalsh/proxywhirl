name: Generate Proxy Lists

on:
  schedule:
    # Run every 2 hours for fresher proxies
    - cron: '0 */2 * * *'
  workflow_dispatch: # Allow manual triggers

# Ensure only one instance runs at a time to prevent database conflicts
concurrency:
  group: proxy-generation
  cancel-in-progress: false

jobs:
  generate-proxy-lists:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        # Fetch with token that has write access for pushing
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        version: "latest"

    - name: Install dependencies
      run: |
        uv venv
        uv pip install -e .

    - name: Install Playwright browsers
      run: |
        # Required for JS-rendered sources
        uv run python -m playwright install chromium

    - name: Fetch and validate proxies
      run: |
        # Use 30s timeout to allow slow international proxies to respond
        # Higher concurrency to process 100k+ proxies faster
        uv run proxywhirl fetch --timeout 30 --concurrency 1000

    - name: Export data for web dashboard
      run: |
        uv run proxywhirl export

    - name: Commit and push if changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        # Add all generated files
        git add docs/proxy-lists/ proxywhirl.db
        
        # Stash any other changes to avoid rebase conflicts
        git stash --include-untracked || true

        # Only commit if there are staged changes
        if git diff --staged --quiet; then
          echo "No changes to commit"
          git stash pop || true
        else
          git commit -m "chore: Update proxy lists and database - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

          # Pull with rebase to handle any concurrent changes, then push
          git pull --rebase origin main || true
          git push
          
          # Restore stashed changes
          git stash pop || true
        fi

    - name: Upload proxy lists as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: proxy-lists-${{ github.run_number }}
        path: docs/proxy-lists/
        retention-days: 7

    - name: Upload database as artifact
      uses: actions/upload-artifact@v4
      with:
        name: proxywhirl-db-${{ github.run_number }}
        path: proxywhirl.db
        retention-days: 30
