name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight UTC
  workflow_dispatch:

jobs:
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: python
          queries: security-and-quality

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:python"

  pip-audit:
    name: Dependency Audit - Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Install dependencies
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Run pip-audit
        run: |
          # Audit installed packages for known vulnerabilities
          # Generate JSON output for artifacts (always runs)
          uvx pip-audit \
            --format json \
            --output pip-audit-${{ matrix.python-version }}.json \
            || true

          # Run with markdown output and fail on vulnerabilities
          # This allows artifacts to be uploaded before failing
          uvx pip-audit --format markdown

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-results-py${{ matrix.python-version }}
          path: pip-audit-*.json
          retention-days: 30

  bandit:
    name: Bandit Security Linter
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Run Bandit security scan
        run: |
          # Scan for common security issues in Python code
          # -r: recursive, -ll: medium severity or higher
          # Generate JSON for artifacts (always runs)
          uvx bandit \
            -r proxywhirl/ \
            -f json \
            -o bandit-report.json \
            -ll \
            || true

          # Run again and fail on security issues
          # This allows artifacts to be uploaded before failing
          uvx bandit -r proxywhirl/ -ll --format screen

      - name: Upload Bandit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-results
          path: bandit-report.json
          retention-days: 30

  safety:
    name: Safety Dependency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Install dependencies
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Run Safety check
        run: |
          # Alternative to pip-audit using Safety DB
          # Generate JSON for artifacts (always runs)
          uvx safety check --json --output safety-report.json || true

          # Run again and fail on vulnerabilities
          # This allows artifacts to be uploaded before failing
          uvx safety check

      - name: Upload Safety results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: safety-results
          path: safety-report.json
          retention-days: 30

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          comment-summary-in-pr: true
